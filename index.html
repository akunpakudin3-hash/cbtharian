<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT Informatika - Jejak Digital</title>
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. REACT & REACT DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. BABEL (Untuk JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. SUPABASE JS (Updated to unpkg for better UMD support) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- 5. SHEETJS (Untuk Export Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <!-- 6. FONT (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .scroll-smooth { scroll-behavior: smooth; }
        
        /* Drag & Drop Styles */
        .draggable-source { cursor: grab; }
        .draggable-source:active { cursor: grabbing; }
        .drop-zone { transition: all 0.2s ease; }
        .drop-zone.active { border-color: #4f46e5; background-color: #eef2ff; transform: scale(1.02); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // KONFIGURASI SUPABASE (WAJIB DIISI)
        // ==========================================
        const SUPABASE_URL = "https://qikeneczlyvbjprnhxyl.supabase.co"; // Isi URL Project Supabase Anda
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpa2VuZWN6bHl2Ympwcm5oeHlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MDM1MTYsImV4cCI6MjA4NjE3OTUxNn0.qRdHiFNMOnxYDOLz9Q-CsistIrYn0GT7HXX4FNkD1d4"; // Isi Anon Key Supabase Anda
        
        // Inisialisasi Client Supabase
        let supabaseClient = null;
        try {
            if (SUPABASE_URL && SUPABASE_ANON_KEY) {
                // Check if the global variable 'supabase' exists (from the script tag)
                if (typeof supabase !== 'undefined') {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                } else if (window.supabase) {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                } else {
                    console.error("Supabase library not loaded properly.");
                }
            }
        } catch (error) {
            console.error("Error initializing Supabase:", error);
        }

        const { useState, useEffect } = React;

        // --- ICON COMPONENTS ---
        const Icon = ({ path, className, fill="none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Brain: <><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6 6.5"/><path d="M3.477 12.578c.25.3.56.548.9.721"/><path d="M20.52 12.578c-.25.3-.56.548-.9.721"/></>,
            User: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
            Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
            Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
            FileText: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>,
            CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
            XCircle: <><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></>,
            LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>,
            GraduationCap: <><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></>,
            Hash: <><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></>,
            Save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>,
            Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>,
            Loader: <path d="M21 12a9 9 0 1 1-6.219-8.56"/>,
            Eye: <><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></>,
            X: <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>,
            Move: <><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="19 9 22 12 19 15"/><polyline points="9 19 12 22 15 19"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/></>
        };

        // --- BANK SOAL (40 Soal HOTS) ---
        const INITIAL_QUESTIONS = [
             // === BAGIAN 1: PILIHAN GANDA (MC) - Analisis & Evaluasi ===
             { id: 1, category: 'mc', type: 'choice', question: "(Analisis Kasus) Seorang pelamar kerja ditolak oleh perusahaan multinasional meskipun memiliki IPK 4.0. Pihak HRD menemukan komentar provokatif di akun media sosial anonim pelamar tersebut dari 5 tahun lalu. Kesimpulan paling logis dari kasus ini adalah...", options: ["Perusahaan melanggar hak privasi karena menelusuri akun anonim.", "Jejak digital bersifat abadi (persisten) dan anonimitas di internet hanyalah ilusi semu.", "Pelamar seharusnya menghapus akun tersebut tepat sehari sebelum wawancara.", "Media sosial tidak mencerminkan kepribadian asli seseorang, hanya hiburan."], correctAnswer: 1 },
             { id: 2, category: 'mc', type: 'choice', question: "(Evaluasi Keamanan) Budi memposting foto Boarding Pass tiket pesawatnya di Instagram Story dengan menutupi nama penumpangnya menggunakan stiker. Mengapa tindakan Budi dinilai MASIH BERISIKO tinggi?", options: ["Karena teman-temannya bisa merasa iri dan melakukan cyberbullying.", "Karena kode Barcode/QR pada tiket masih dapat dipindai untuk mengungkapkan data sensitif (NIK, PNR).", "Karena maskapai penerbangan akan membatalkan tiket secara otomatis jika terdeteksi online.", "Karena kualitas foto akan menurun (pecah) saat diunggah."], correctAnswer: 1 },
             { id: 3, category: 'mc', type: 'choice', question: "(Logika Teknis) Seorang siswa menggunakan 'Incognito Mode' di laboratorium komputer sekolah untuk mengakses situs game yang diblokir. Namun, admin sekolah tetap mengetahui aktivitas tersebut. Mengapa hal ini bisa terjadi?", options: ["Karena siswa lupa menghapus riwayat penelusuran (History).", "Karena Incognito hanya mencegah penyimpanan data di perangkat lokal, bukan mengenkripsi lalu lintas data di jaringan ISP/Router.", "Karena admin sekolah memasang kamera CCTV di belakang layar.", "Karena Incognito Mode sedang mengalami gangguan server global."], correctAnswer: 1 },
             { id: 4, category: 'mc', type: 'choice', question: "(Analisis Dampak) Fenomena 'Sharenting' (Orang tua membagikan foto anak secara berlebihan) sering dianggap sepele. Namun, risiko jangka panjang terbesar bagi 'Identitas Digital' anak di masa depan adalah...", options: ["Anak menjadi terlalu terkenal dan sulit bergaul.", "Anak kehilangan hak atas privasinya sendiri dan berisiko mengalami penyalahgunaan data biometrik.", "Memori penyimpanan awan (Cloud Storage) orang tua menjadi penuh.", "Anak akan tumbuh menjadi pribadi yang narsis."], correctAnswer: 1 },
             { id: 5, category: 'mc', type: 'choice', question: "(Perbandingan Konsep) Perhatikan dua aktivitas berikut: (A) Mengirim email lamaran pekerjaan. (B) Aplikasi peta merekam rute perjalanan harianmu di latar belakang. Analisis yang tepat mengenai klasifikasi jejak digital keduanya adalah...", options: ["(A) adalah Jejak Pasif, sedangkan (B) adalah Jejak Aktif.", "(A) adalah Jejak Aktif (Sadar), sedangkan (B) adalah Jejak Pasif (Tanpa Sadar).", "Keduanya merupakan Jejak Digital Pasif.", "Keduanya merupakan Jejak Digital Aktif."], correctAnswer: 1 },
             { id: 6, category: 'mc', type: 'choice', question: "(Literasi Digital) Kamu menerima pesan WhatsApp: 'Kuota Belajar Gratis Kemdikbud! Klik: http://kuota-kemdikbud-gratis.xyz'. Langkah nalar kritis pertama yang harus dilakukan sebelum bertindak adalah...", options: ["Segera klik tautan tersebut sebelum masa berlaku habis.", "Meneruskan (Forward) ke grup kelas agar teman-teman juga mendapatkannya.", "Menganalisis domain URL. Karena menggunakan '.xyz' dan bukan '.go.id', maka indikasi kuat Phishing.", "Mengisi data nama dan nomor HP untuk membuktikan kebenarannya."], correctAnswer: 2 },
             { id: 7, category: 'mc', type: 'choice', question: "(Konsep Data) Mengapa tindakan menghapus (delete) postingan di media sosial tidak menjamin jejak digital tersebut hilang 100% dari internet?", options: ["Karena tombol hapus di aplikasi seringkali mengalami kerusakan teknis.", "Karena konten mungkin sudah di-screenshot orang lain atau tersimpan di server backup penyedia layanan (Mirroring).", "Karena internet memiliki kapasitas penyimpanan tak terbatas.", "Karena pemerintah melarang penghapusan data digital."], correctAnswer: 1 },
             { id: 8, category: 'mc', type: 'choice', question: "(Hukum & Etika) Jika terjadi kasus cyberbullying menggunakan akun palsu (fake account), siapakah subjek hukum yang paling bertanggung jawab menurut UU ITE?", options: ["Penyedia platform media sosial (seperti Instagram/Twitter).", "Pihak sekolah karena kurang pengawasan.", "Pemilik asli akun tersebut, karena jejak digital (IP Address/Device ID) dapat dilacak secara forensik.", "Korban, karena terlalu sensitif menanggapi komentar."], correctAnswer: 2 },
             { id: 9, category: 'mc', type: 'choice', question: "(Strategi) Langkah paling logis dan efektif untuk melakukan 'Manajemen Reputasi Online' sebelum memasuki dunia kerja adalah...", options: ["Menghapus permanen seluruh akun media sosial agar tidak bisa dilacak.", "Melakukan 'Self-Googling' untuk audit, menghapus konten negatif, dan memperbanyak konten karya positif.", "Mengganti nama asli dengan nama samaran di semua dokumen resmi.", "Membuat ratusan status positif dalam satu malam."], correctAnswer: 1 },
             { id: 10, category: 'mc', type: 'choice', question: "(Sistem Komputer) Ketika kamu mencari 'Sepatu Lari' di Google, tiba-tiba iklan sepatu muncul di Instagram dan Facebook-mu. Teknologi apa yang bekerja di latar belakang untuk menghubungkan data ini?", options: ["Virus Trojan yang mencuri data.", "Cookies pihak ketiga (Third-party Cookies) dan Algoritma Pelacakan Lintas Situs.", "Kamera HP yang merekam bola mata pengguna.", "Admin media sosial memantau aktivitasmu secara manual."], correctAnswer: 1 },
             { id: 11, category: 'mc', type: 'choice', question: "(Keamanan Jaringan) Mengapa melakukan transaksi Mobile Banking menggunakan Wi-Fi publik gratis (tanpa VPN) sangat tidak disarankan?", options: ["Karena koneksi Wi-Fi publik biasanya lambat.", "Karena jaringan publik rentan terhadap serangan 'Man-in-the-Middle' (Penyadapan/Sniffing) data yang tidak terenkripsi.", "Karena akan dikenakan biaya tambahan oleh pemilik Wi-Fi.", "Karena baterai HP akan lebih cepat habis."], correctAnswer: 1 },
             { id: 12, category: 'mc', type: 'choice', question: "(Etika Digital) Memposting foto teman yang sedang tidur dengan mulut terbuka sebagai bahan lelucon (meme) tanpa izin, secara etika melanggar prinsip...", options: ["Hak Cipta (Copyright).", "Consent (Persetujuan) dan Penghormatan Privasi.", "Kebebasan Berpendapat.", "Kreativitas Digital."], correctAnswer: 1 },
             
             // === BAGIAN 2A: BENAR/SALAH (BS) ===
             { id: 13, category: 'bs', type: 'choice', question: "(B/S) Mengaktifkan 'Mode Pesawat' (Airplane Mode) saat mengambil foto menjamin foto tersebut tidak akan memiliki metadata lokasi (Geotagging) sama sekali.", options: ["Benar", "Salah (Jika GPS aktif sebelumnya, koordinat terakhir bisa tersimpan)"], correctAnswer: 1 },
             { id: 14, category: 'bs', type: 'choice', question: "(B/S) Jejak digital pasif (seperti riwayat pencarian dan lokasi GPS) seringkali lebih berbahaya daripada jejak aktif karena tercipta tanpa kesadaran penuh pengguna.", options: ["Benar", "Salah"], correctAnswer: 0 },

             // === BAGIAN 2B: MENJODOHKAN (MATCH) - Analogi & Definisi ===
             { id: 15, category: 'match', type: 'choice', question: "Pasangkan konsep 'Phishing' dengan analogi dunia nyata yang paling tepat:", options: ["Pencuri yang membobol rumah paksa", "Penipu yang menyamar jadi petugas bank untuk minta PIN", "Penguntit yang mengikuti diam-diam", "Tukang pos yang salah alamat"], correctAnswer: 1 },
             { id: 16, category: 'match', type: 'choice', question: "Pasangkan jenis jejak digital dengan contoh konkretnya:", options: ["Jejak Pasif - Komentar di YouTube", "Jejak Aktif - Log Server ISP", "Jejak Pasif - Alamat IP & Metadata Foto", "Jejak Aktif - Iklan yang muncul otomatis"], correctAnswer: 2 },
             { id: 17, category: 'match', type: 'choice', question: "Manakah pasangan sebab-akibat keamanan siber yang logis?", options: ["Password 123456 - Akun sulit diretas", "Mengaktifkan 2FA - Lapisan keamanan ganda", "Klik Link Sembarang - Smartphone jadi cepat", "Update OS - HP jadi lambat"], correctAnswer: 1 },
             { id: 18, category: 'match', type: 'choice', question: "Jodohkan istilah 'Doxing' dengan definisi operasionalnya:", options: ["Menebak password akun", "Menyebarkan data pribadi (alamat/No HP) untuk intimidasi", "Mengambil alih akun game", "Menjual barang palsu"], correctAnswer: 1 },
             { id: 19, category: 'match', type: 'choice', question: "Pasangkan indikator keamanan URL dengan maknanya:", options: ["HTTPS (Gembok) - Komunikasi data terenkripsi", "HTTP - Sangat Aman untuk Transaksi", "Domain .xyz - Situs Pemerintah Resmi", "Warna Merah - Website Terpercaya"], correctAnswer: 0 },
             { id: 20, category: 'match', type: 'choice', question: "Jodohkan teknik 'Social Engineering' dengan metodenya:", options: ["Menggunakan software canggih", "Memanipulasi psikologis manusia (rasa takut/penasaran)", "Memutus kabel internet", "Mencuri sinyal satelit"], correctAnswer: 1 },
             { id: 21, category: 'match', type: 'choice', question: "Pasangkan pelanggaran etika dengan istilahnya:", options: ["Mengutip tanpa sumber - Fair Use", "Mengambil karya orang & aku-aku - Plagiarisme", "Menulis email - Spamming", "Sopan santun - Cyberbullying"], correctAnswer: 1 },
             { id: 22, category: 'match', type: 'choice', question: "Manakah pasangan praktik keamanan password yang BURUK?", options: ["Password - Tanggal Lahir Lengkap", "Password - Kalimat Panjang (Passphrase)", "Password - Kombinasi Simbol", "Password - Berbeda tiap akun"], correctAnswer: 0 },
             { id: 23, category: 'match', type: 'choice', question: "Jodohkan istilah 'Digital Footprint' dengan metafora ekonominya:", options: ["Mata Uang Baru (Reputasi bernilai ekonomi)", "Sampah Daur Ulang", "Jejak di Pantai (Mudah hilang)", "Uang Kripto"], correctAnswer: 0 },
             { id: 24, category: 'match', type: 'choice', question: "Pasangkan fitur privasi medsos dengan fungsinya:", options: ["Block - Melaporkan konten ilegal", "Mute - Menyembunyikan postingan tanpa memutus pertemanan", "Report - Menutup jalur komunikasi", "Unfollow - Menghapus akun"], correctAnswer: 1 },
             { id: 25, category: 'match', type: 'choice', question: "Jodohkan ekstensi file dengan potensi risikonya:", options: [".txt - Risiko Tinggi Virus", ".jpg - Risiko Sedang", ".exe / .apk - Risiko Tinggi (Executable)", ".mp3 - Risiko Sangat Tinggi"], correctAnswer: 2 },
             { id: 26, category: 'match', type: 'choice', question: "Pasangkan UU ITE dengan jenis pelanggaran utamanya:", options: ["Pasal 27 - Pencemaran Nama Baik / Kesusilaan", "Pasal 27 - Pencurian Hardware", "Pasal 28 - Pelanggaran Lampu Merah", "Pasal 29 - Korupsi"], correctAnswer: 0 },
             { id: 27, category: 'match', type: 'choice', question: "Jodohkan istilah 'Digital Detox' dengan tujuannya:", options: ["Menambah Followers", "Mengurangi kecanduan & menjaga kesehatan mental", "Meningkatkan penjualan online", "Mempercepat koneksi internet"], correctAnswer: 1 },

             // === BAGIAN 3: URAIAN / ESSAY (ESSAY) - Analisis Mendalam ===
             { id: 28, category: 'essay', type: 'essay', question: "Studi Kasus: Seorang lulusan terbaik gagal diterima kerja karena tim HRD menemukan jejak digitalnya sering berkata kasar di kolom komentar game online 7 tahun lalu. Analisislah mengapa perusahaan modern menganggap 'Jejak Digital' sama pentingnya dengan 'Ijazah Akademik'!", keywords: ["karakter", "reputasi", "integritas", "budaya kerja", "risiko", "citra perusahaan"], minKeywords: 3, maxScore: 10 },
             { id: 29, category: 'essay', type: 'essay', question: "Analisis Kritis: Fitur GPS pada aplikasi Ojek Online memberikan kenyamanan (akurasi penjemputan) tetapi juga ancaman privasi (pelacakan pola hidup). Jelaskan bagaimana kamu menyeimbangkan 'Kenyamanan vs Privasi' dalam kasus ini!", keywords: ["izin akses", "hanya saat digunakan", "matikan gps", "privasi", "data lokasi", "kesadaran"], minKeywords: 3, maxScore: 10 },
             { id: 30, category: 'essay', type: 'essay', question: "Problem Solving: Temanmu panik karena ada akun palsu (impersonation) yang menggunakan foto dan namanya untuk menipu orang lain meminjam uang. Rumuskan 3 langkah darurat yang harus segera dilakukan temanmu!", keywords: ["lapor", "report akun", "klarifikasi publik", "bukti screenshot", "blokir", "bantuan teman"], minKeywords: 3, maxScore: 10 },
             { id: 31, category: 'essay', type: 'essay', question: "Evaluasi: Banyak orang merasa aman karena 'tidak punya rahasia'. Bantahlah argumen tersebut dengan menjelaskan bahaya 'Profiling Data' dari jejak digital pasif (seperti riwayat belanja dan lokasi)!", keywords: ["manipulasi", "target iklan", "pencurian identitas", "rekayasa sosial", "prediksi perilaku", "data agregat"], minKeywords: 3, maxScore: 10 },
             { id: 32, category: 'essay', type: 'essay', question: "Kreasi: Buatlah sebuah kalimat slogan kampanye tentang 'Etika Berinternet' yang menargetkan remaja, lalu jelaskan pesan filosofis di balik slogan buatanmu!", keywords: ["pikir", "jari", "masa depan", "jejak", "positif", "bijak", "saring"], minKeywords: 2, maxScore: 10 },
             { id: 33, category: 'essay', type: 'essay', question: "Analisis Keamanan: Mengapa menggunakan Tanggal Lahir sebagai PIN atau Password dianggap sebagai 'Dosa Besar' dalam keamanan siber? Jelaskan kaitannya dengan teknik 'Social Engineering'!", keywords: ["data publik", "mudah ditebak", "rekayasa sosial", "profiling", "lemah", "brute force"], minKeywords: 3, maxScore: 10 },
             { id: 34, category: 'essay', type: 'essay', question: "Hukum: Jelaskan bagaimana sebuah komentar pendek di media sosial (\"hate speech\") dapat berujung pada penjara menurut UU ITE di Indonesia? Apa unsur yang dilanggar?", keywords: ["pencemaran nama baik", "ujaran kebencian", "sara", "pasal 27", "pasal 28", "pidana", "digital"], minKeywords: 3, maxScore: 10 },
             { id: 35, category: 'essay', type: 'essay', question: "Komparasi: Jelaskan perbedaan fungsi strategis antara fitur 'Block' dan 'Report'! Dalam situasi apa kamu harus memilih Report daripada sekadar Block?", keywords: ["block memutus", "report melapor", "pelanggaran komunitas", "tindakan admin", "berbahaya", "ilegal"], minKeywords: 3, maxScore: 10 },
             { id: 36, category: 'essay', type: 'essay', question: "Studi Kasus: Kamu menerima email dari pengirim tak dikenal dengan subjek 'HADIAH MENANG' dan lampiran file berekstensi '.exe'. Analisis risiko apa yang terjadi jika kamu mengunduh file tersebut!", keywords: ["malware", "virus", "ransomware", "executable", "pencurian data", "merusak sistem"], minKeywords: 3, maxScore: 10 },
             { id: 37, category: 'essay', type: 'essay', question: "Opini Kritis: Sekolah berencana menyita HP siswa untuk memeriksa chat pribadi demi mencegah bullying. Setujukah kamu? Berikan argumen berdasarkan hak privasi vs keamanan sekolah!", keywords: ["privasi siswa", "batas wewenang", "hak asasi", "prosedur", "consent", "alternatif edukasi"], minKeywords: 2, maxScore: 10 },
             { id: 38, category: 'essay', type: 'essay', question: "Konsep Baru: Apa yang dimaksud dengan 'Digital Legacy' (Warisan Digital)? Mengapa penting bagi kita untuk mengatur siapa yang boleh mengakses akun kita setelah kita meninggal?", keywords: ["data pasca mati", "penyalahgunaan", "kenangan", "akses ahli waris", "memorialization", "keamanan"], minKeywords: 2, maxScore: 10 },
             { id: 39, category: 'essay', type: 'essay', question: "Analisis Sistem: Bagaimana 'Algoritma Media Sosial' menciptakan 'Filter Bubble' yang membuat kita merasa semua orang sepemikiran dengan kita? Apa bahayanya bagi wawasan kebangsaan?", keywords: ["personalisasi", "minat sama", "mengisolasi", "polarisasi", "sudut pandang sempit", "echo chamber"], minKeywords: 2, maxScore: 10 },
             { id: 40, category: 'essay', type: 'essay', question: "Identifikasi: Sebutkan 3 ciri fisik/visual dari sebuah situs web Phishing yang menyamar sebagai situs login resmi (misal: bank atau game)!", keywords: ["typo domain", "tidak https", "tampilan mirip tapi cacat", "mendesak", "meminta data sensitif", "popup berlebih"], minKeywords: 3, maxScore: 10 },
        ];

        // --- UTILS ---
        const shuffleArray = (array) => {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        };

        const simulateAIAnalysis = async (answer, keywords, minKeywords) => {
            return new Promise((resolve) => {
                setTimeout(() => {
                    if (!answer || answer.trim().length < 5) {
                        resolve({ score: 0, feedback: "Jawaban terlalu singkat." });
                        return;
                    }
                    const lowerAnswer = answer.toLowerCase();
                    const matchCount = keywords.filter(k => lowerAnswer.includes(k)).length;
                    
                    let score = 30; // Base score
                    let feedback = "Kurang lengkap.";
                    
                    if (matchCount >= minKeywords) {
                        score = 100;
                        feedback = "Sangat Baik! Argumen lengkap.";
                    } else if (matchCount >= Math.ceil(minKeywords / 2)) {
                        score = 70;
                        feedback = "Cukup baik, perlu lebih detail.";
                    }
                    
                    resolve({ score, feedback });
                }, 1000);
            });
        };

        // ==========================================
        // COMPONENTS
        // ==========================================

        function LoginScreen({ onLogin }) {
            const [role, setRole] = useState('student');
            const [name, setName] = useState('');
            const [password, setPassword] = useState('');
            const [kelas, setKelas] = useState('');
            const [absen, setAbsen] = useState('');

            const handleStudentLogin = () => {
                if (name && kelas && absen) {
                    onLogin(name.toUpperCase(), 'student', null, { kelas, absen });
                } else {
                    alert("Mohon lengkapi Nama, Kelas, dan No Absen!");
                }
            };

            return (
                <div className="flex justify-center items-center min-h-[80vh]">
                    <div className="bg-white p-8 rounded-xl shadow-xl w-full max-w-md border border-slate-200">
                        <div className="text-center mb-6">
                            <div className="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-3 text-indigo-600">
                                <Icon path={Icons.Brain} className="w-8 h-8" />
                            </div>
                            <h2 className="text-2xl font-bold text-slate-800">CBT Informatika</h2>
                            <p className="text-slate-500">Jejak Digital & Keamanan Siber</p>
                        </div>

                        <div className="flex bg-slate-100 p-1 rounded-lg mb-6">
                            <button onClick={() => setRole('student')} className={`flex-1 py-2 text-sm font-medium rounded-md transition ${role === 'student' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>Siswa</button>
                            <button onClick={() => setRole('admin')} className={`flex-1 py-2 text-sm font-medium rounded-md transition ${role === 'admin' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>Guru Admin</button>
                        </div>

                        {role === 'student' ? (
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Lengkap</label>
                                    <div className="relative">
                                        <div className="absolute left-3 top-2.5 text-slate-400"><Icon path={Icons.User} className="w-5 h-5"/></div>
                                        <input type="text" value={name} onChange={e => setName(e.target.value.toUpperCase())} className="w-full pl-10 p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none uppercase" placeholder="NAMA SISWA" />
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Kelas</label>
                                        <div className="relative">
                                            <div className="absolute left-3 top-2.5 text-slate-400"><Icon path={Icons.GraduationCap} className="w-5 h-5"/></div>
                                            <select value={kelas} onChange={e => setKelas(e.target.value)} className="w-full pl-10 p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                                                <option value="">Pilih</option>
                                                <option value="VIII-A">VIII-A</option>
                                                <option value="VIII-B">VIII-B</option>
                                                <option value="VIII-C">VIII-C</option>
                                                <option value="VIII-D">VIII-D</option>
                                                <option value="VIII-E">VIII-E</option>
                                                <option value="VIII-F">VIII-F</option>
                                                <option value="VIII-G">VIII-G</option>
                                                <option value="VIII-H">VIII-H</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Absen</label>
                                        <div className="relative">
                                            <div className="absolute left-3 top-2.5 text-slate-400"><Icon path={Icons.Hash} className="w-5 h-5"/></div>
                                            <input type="number" value={absen} onChange={e => setAbsen(e.target.value)} className="w-full pl-10 p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="1-40" />
                                        </div>
                                    </div>
                                </div>
                                <button onClick={handleStudentLogin} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold shadow-lg transition transform hover:scale-[1.02]">Mulai Ujian</button>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Password Admin</label>
                                    <div className="relative">
                                        <div className="absolute left-3 top-2.5 text-slate-400"><Icon path={Icons.Lock} className="w-5 h-5"/></div>
                                        <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full pl-10 p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Masukkan Kode..." />
                                    </div>
                                </div>
                                <button onClick={() => onLogin('Admin', 'admin', password)} className="w-full bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-lg font-bold shadow-lg">Masuk Panel Guru</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function StudentDashboard({ user, onStart }) {
            return (
                <div className="max-w-2xl mx-auto mt-12 bg-white p-8 rounded-xl shadow-lg border border-slate-200 text-center">
                    <div className="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600">
                        <Icon path={Icons.User} className="w-10 h-10" />
                    </div>
                    <h2 className="text-2xl font-bold text-slate-800">Halo, {user.name}</h2>
                    <p className="text-slate-500 mb-6 font-medium">Kelas {user.kelas} | No. Absen {user.absen}</p>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-left">
                         <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <span className="text-xs font-bold text-slate-400 uppercase">Jumlah Soal</span>
                            <p className="text-xl font-bold text-slate-800">25 Butir</p>
                         </div>
                         <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <span className="text-xs font-bold text-slate-400 uppercase">Waktu</span>
                            <p className="text-xl font-bold text-slate-800">40 Menit</p>
                         </div>
                         <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <span className="text-xs font-bold text-slate-400 uppercase">Sistem</span>
                            <p className="text-xl font-bold text-slate-800">Acak Terstruktur</p>
                         </div>
                    </div>

                    <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200 text-yellow-800 text-sm text-left mb-6">
                        <strong>Perhatian:</strong> Soal akan diacak dari bank soal dengan komposisi: PG (Awal), Menjodohkan (Tengah), Uraian (Akhir).
                    </div>

                    <button onClick={onStart} className="px-8 py-3 bg-indigo-600 text-white rounded-full font-bold shadow-lg hover:bg-indigo-700 transition w-full md:w-auto">
                        Mulai Mengerjakan
                    </button>
                </div>
            );
        }

        function ExamInterface({ questions, answers, setAnswers, onSubmit, timeLeft, isSubmitting }) {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [dragOver, setDragOver] = useState(false);

            const formatTime = (s) => {
                const m = Math.floor(s / 60);
                const sc = s % 60;
                return `${m}:${sc < 10 ? '0' : ''}${sc}`;
            };

            const handleDragStart = (e, index) => {
                e.dataTransfer.setData("text/plain", index);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                setDragOver(true);
            };

            const handleDragLeave = () => {
                setDragOver(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setDragOver(false);
                const draggedIndex = parseInt(e.dataTransfer.getData("text/plain"));
                if (!isNaN(draggedIndex)) {
                    setAnswers({...answers, [questions[currentIndex].id]: draggedIndex});
                }
            };

            if (isSubmitting) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-[60vh]">
                        <div className="animate-spin text-indigo-600 mb-4"><Icon path={Icons.Loader} className="w-12 h-12" /></div>
                        <h3 className="text-xl font-bold text-slate-700">Sedang Mengirim Jawaban...</h3>
                        <p className="text-slate-500">Mohon jangan tutup halaman ini.</p>
                    </div>
                );
            }

            const currentQ = questions[currentIndex];
            const isLastQuestion = currentIndex === questions.length - 1;
            const isFirstQuestion = currentIndex === 0;

            const handleNext = () => {
                if (!isLastQuestion) setCurrentIndex(prev => prev + 1);
            };

            const handlePrev = () => {
                if (!isFirstQuestion) setCurrentIndex(prev => prev - 1);
            };

            return (
                <div className="flex flex-col md:flex-row gap-6 items-start max-w-6xl mx-auto p-4">
                    {/* Main Question Area */}
                    <div className="flex-1 w-full space-y-6 pb-10">
                        {/* Single Question Card */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 min-h-[400px] flex flex-col">
                            <div className="flex gap-4 mb-4">
                                <span className="flex-shrink-0 w-10 h-10 bg-indigo-100 text-indigo-700 font-bold rounded-lg flex items-center justify-center text-lg">{currentIndex + 1}</span>
                                <div className="flex-1">
                                    <p className="font-medium text-lg text-slate-800 leading-relaxed">{currentQ.question}</p>
                                    <div className="flex gap-2 mt-2">
                                        {currentQ.category === 'essay' && <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded font-medium">Uraian</span>}
                                        {currentQ.category === 'match' && <span className="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded font-medium">Menjodohkan (Geser)</span>}
                                        {currentQ.category === 'bs' && <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded font-medium">Benar/Salah</span>}
                                        {currentQ.category === 'mc' && <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded font-medium">Pilihan Ganda</span>}
                                    </div>
                                </div>
                            </div>

                            <div className="flex-1 pl-0 md:pl-14">
                                {currentQ.category === 'match' ? (
                                    <div className="space-y-6">
                                        {/* Drop Zone */}
                                        <div 
                                            onDragOver={handleDragOver}
                                            onDragLeave={handleDragLeave}
                                            onDrop={handleDrop}
                                            className={`p-6 border-2 border-dashed rounded-xl flex flex-col items-center justify-center text-center transition-all duration-200 min-h-[120px] drop-zone ${dragOver ? 'active' : 'border-slate-300 bg-slate-50'}`}
                                        >
                                            {answers[currentQ.id] !== undefined ? (
                                                <div className="bg-indigo-600 text-white p-4 rounded-lg shadow-md w-full max-w-md font-bold flex items-center justify-between">
                                                    <span>{currentQ.options[answers[currentQ.id]]}</span>
                                                    <button onClick={(e) => { e.stopPropagation(); setAnswers({...answers, [currentQ.id]: undefined}); }} className="ml-2 hover:bg-indigo-700 rounded p-1"><Icon path={Icons.X} className="w-4 h-4 text-white"/></button>
                                                </div>
                                            ) : (
                                                <div className="text-slate-400 pointer-events-none">
                                                    <Icon path={Icons.Move} className="w-8 h-8 mx-auto mb-2 opacity-50"/>
                                                    <p className="font-medium text-sm">Geser balok jawaban yang benar ke kotak ini</p>
                                                </div>
                                            )}
                                        </div>

                                        {/* Draggable Options */}
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            {currentQ.options.map((opt, oIdx) => (
                                                <div 
                                                    key={oIdx}
                                                    draggable={true}
                                                    onDragStart={(e) => handleDragStart(e, oIdx)}
                                                    onClick={() => setAnswers({...answers, [currentQ.id]: oIdx})} // Keep click for mobile fallback
                                                    className={`p-4 rounded-lg border bg-white shadow-sm hover:shadow-md transition-all draggable-source 
                                                        ${answers[currentQ.id] === oIdx ? 'opacity-50 ring-2 ring-indigo-200' : 'border-slate-200'}
                                                    `}
                                                >
                                                    <div className="flex items-center gap-3">
                                                        <div className="bg-slate-100 p-2 rounded text-slate-500"><Icon path={Icons.Move} className="w-4 h-4"/></div>
                                                        <span className="font-medium text-slate-700">{opt}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ) : currentQ.type === 'choice' ? (
                                    <div className="space-y-3">
                                        {currentQ.options.map((opt, oIdx) => (
                                            <button 
                                                key={oIdx}
                                                onClick={() => setAnswers({...answers, [currentQ.id]: oIdx})}
                                                className={`w-full text-left p-4 rounded-lg border transition flex items-center gap-3 ${answers[currentQ.id] === oIdx ? 'bg-indigo-50 border-indigo-500 text-indigo-800 font-medium ring-1 ring-indigo-500' : 'hover:bg-slate-50 border-slate-200 text-slate-600'}`}
                                            >
                                                <div className={`w-5 h-5 rounded-full border flex items-center justify-center flex-shrink-0 ${answers[currentQ.id] === oIdx ? 'border-indigo-500 bg-indigo-500' : 'border-slate-300'}`}>
                                                    {answers[currentQ.id] === oIdx && <div className="w-2 h-2 bg-white rounded-full"></div>}
                                                </div>
                                                {opt}
                                            </button>
                                        ))}
                                    </div>
                                ) : (
                                    <textarea 
                                        value={answers[currentQ.id] || ''}
                                        onChange={e => setAnswers({...answers, [currentQ.id]: e.target.value})}
                                        className="w-full p-4 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none h-48 resize-none text-slate-700"
                                        placeholder="Ketik jawaban uraian Anda di sini..."
                                    ></textarea>
                                )}
                            </div>

                            {/* Navigation Buttons */}
                            <div className="mt-8 pt-6 border-t border-slate-100 flex justify-between items-center">
                                <button 
                                    onClick={handlePrev}
                                    disabled={isFirstQuestion}
                                    className={`px-6 py-2.5 rounded-lg font-medium flex items-center gap-2 transition ${isFirstQuestion ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-white border border-slate-300 text-slate-700 hover:bg-slate-50'}`}
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                                    Sebelumnya
                                </button>

                                {isLastQuestion ? (
                                    <button 
                                        onClick={() => { if(confirm("Yakin ingin mengakhiri ulangan? Pastikan semua jawaban sudah terisi.")) onSubmit(); }}
                                        className="px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold shadow-md transition flex items-center gap-2"
                                    >
                                        <Icon path={Icons.CheckCircle} className="w-5 h-5"/> Akhiri Ulangan
                                    </button>
                                ) : (
                                    <button 
                                        onClick={handleNext}
                                        className="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold shadow-md transition flex items-center gap-2"
                                    >
                                        Selanjutnya
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Sidebar */}
                    <div className="w-full md:w-80 flex-shrink-0 space-y-4 sticky top-4">
                        <div className="bg-white p-5 rounded-xl shadow border border-slate-200 text-center">
                            <span className="text-xs font-bold text-slate-400 uppercase flex items-center justify-center gap-1 mb-1">
                                <Icon path={Icons.Clock} className="w-3 h-3"/> Sisa Waktu
                            </span>
                            <div className={`text-3xl font-mono font-bold ${timeLeft < 300 ? 'text-red-500 animate-pulse' : 'text-slate-800'}`}>
                                {formatTime(timeLeft)}
                            </div>
                        </div>

                        <div className="bg-white p-5 rounded-xl shadow border border-slate-200">
                            <h4 className="font-bold text-sm text-slate-700 mb-4 flex items-center gap-2">
                                <Icon path={Icons.FileText} className="w-4 h-4"/> Navigasi Soal
                            </h4>
                            <div className="grid grid-cols-5 gap-2 max-h-[350px] overflow-y-auto pr-1">
                                {questions.map((q, idx) => {
                                    const isAnswered = answers[q.id] !== undefined && answers[q.id] !== "";
                                    const isActive = idx === currentIndex;
                                    
                                    return (
                                    <button 
                                        key={q.id}
                                        onClick={() => setCurrentIndex(idx)}
                                        className={`aspect-square flex items-center justify-center rounded-lg text-sm font-bold transition border-2 
                                            ${isActive ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-transparent'}
                                            ${!isActive && isAnswered ? 'bg-indigo-600 text-white' : ''}
                                            ${!isActive && !isAnswered ? 'bg-slate-100 text-slate-500 hover:bg-slate-200' : ''}
                                        `}
                                    >
                                        {idx + 1}
                                    </button>
                                )})}
                            </div>
                            <div className="mt-4 flex flex-wrap gap-3 text-xs text-slate-500 justify-center">
                                <div className="flex items-center gap-1"><div className="w-3 h-3 bg-indigo-600 rounded"></div> Dijawab</div>
                                <div className="flex items-center gap-1"><div className="w-3 h-3 border-2 border-indigo-600 bg-indigo-50 rounded"></div> Aktif</div>
                                <div className="flex items-center gap-1"><div className="w-3 h-3 bg-slate-100 rounded"></div> Kosong</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function ResultScreen({ score, user, onHome }) {
            const isLulus = score >= 75;
            return (
                <div className="flex justify-center items-center min-h-[80vh] p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg text-center border border-slate-100 relative overflow-hidden">
                        <div className={`absolute top-0 left-0 w-full h-2 ${isLulus ? 'bg-green-500' : 'bg-red-500'}`}></div>
                        <div className={`w-20 h-20 rounded-full mx-auto flex items-center justify-center mb-6 ${isLulus ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                            <Icon path={isLulus ? Icons.CheckCircle : Icons.XCircle} className="w-10 h-10" />
                        </div>
                        
                        <h2 className="text-3xl font-bold text-slate-800 mb-2">{isLulus ? "Selamat! Anda Lulus" : "Belum Lulus"}</h2>
                        <p className="text-slate-500 mb-6">Terima kasih telah mengikuti ujian.</p>
                        
                        <div className="bg-slate-50 p-6 rounded-xl border border-slate-200 mb-8">
                            <div className="flex justify-between items-center mb-2 text-sm text-slate-500">
                                <span>{user.name}</span>
                                <span>{user.kelas}</span>
                            </div>
                            <div className="text-6xl font-bold text-slate-800">{score}</div>
                            <div className="text-xs text-slate-400 mt-1 uppercase tracking-wide">Nilai Akhir</div>
                        </div>

                        <button onClick={onHome} className="w-full bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-lg font-bold">Kembali ke Halaman Login</button>
                    </div>
                </div>
            );
        }

        function ViewDetailModal({ resultId, onClose }) {
            const [details, setDetails] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                fetchDetails();
            }, []);

            const fetchDetails = async () => {
                if (supabase) {
                    const { data, error } = await supabase
                        .from('student_answers')
                        .select('*')
                        .eq('exam_result_id', resultId);
                    if (!error) setDetails(data);
                }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                        <div className="p-6 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
                            <h3 className="font-bold text-lg text-slate-800">Detail Jawaban Siswa</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-red-500"><Icon path={Icons.X} className="w-6 h-6"/></button>
                        </div>
                        <div className="overflow-y-auto p-6 space-y-6 flex-1">
                            {loading ? <p className="text-center">Memuat...</p> : details.length === 0 ? <p className="text-center text-slate-500">Tidak ada detail jawaban (Mode Offline/Lama).</p> : (
                                details.map((ans, idx) => (
                                    <div key={idx} className="border-b pb-4 last:border-0">
                                        <div className="flex justify-between mb-2">
                                            <span className="font-bold text-slate-700">Soal {idx + 1} ({ans.question_type === 'choice' ? 'PG' : 'Essay'})</span>
                                            <span className={`px-2 py-0.5 text-xs rounded font-bold ${ans.is_correct || ans.score > 5 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                Skor: {ans.score}
                                            </span>
                                        </div>
                                        <p className="text-sm text-slate-600 mb-2">{ans.question_text}</p>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                            <div className="bg-slate-50 p-3 rounded">
                                                <p className="text-xs text-slate-400 uppercase font-bold mb-1">Jawaban Siswa</p>
                                                <p className="text-slate-800">{ans.student_answer || "-"}</p>
                                            </div>
                                            {ans.question_type === 'choice' ? (
                                                <div className="bg-green-50 p-3 rounded">
                                                    <p className="text-xs text-green-600 uppercase font-bold mb-1">Kunci Jawaban</p>
                                                    <p className="text-green-800">{ans.correct_answer}</p>
                                                </div>
                                            ) : (
                                                <div className="bg-blue-50 p-3 rounded">
                                                    <p className="text-xs text-blue-600 uppercase font-bold mb-1">Feedback AI</p>
                                                    <p className="text-blue-800">{ans.feedback || "-"}</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function AdminPanel({ onLogout }) {
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedResult, setSelectedResult] = useState(null);

            useEffect(() => {
                fetchResults();
            }, []);

            const fetchResults = async () => {
                setLoading(true);
                if (supabase) {
                    try {
                        const { data, error } = await supabase
                            .from('exam_results')
                            .select('*')
                            .order('created_at', { ascending: false });
                        
                        if (error) throw error;
                        setResults(data);
                    } catch (err) {
                        alert("Gagal ambil data Supabase: " + err.message);
                        setResults(JSON.parse(localStorage.getItem('cbt_local_results') || '[]'));
                    }
                } else {
                    const localData = JSON.parse(localStorage.getItem('cbt_local_results') || '[]');
                    setResults(localData);
                }
                setLoading(false);
            };

            const downloadExcel = () => {
                const worksheet = XLSX.utils.json_to_sheet(results.map(r => ({
                    Tanggal: new Date(r.created_at || r.date).toLocaleString(),
                    Nama: r.name,
                    Kelas: r.kelas,
                    Absen: r.absen,
                    Nilai: r.score
                })));
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Nilai Siswa");
                XLSX.writeFile(workbook, "Rekap_Nilai_CBT.xlsx");
            };

            return (
                <div className="max-w-6xl mx-auto p-6">
                    <div className="flex justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800">Panel Guru</h2>
                            <p className="text-slate-500 text-sm">Rekapitulasi Hasil Ujian</p>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={downloadExcel} className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold text-sm">
                                <Icon path={Icons.Download} className="w-4 h-4" /> Download Excel
                            </button>
                            <button onClick={onLogout} className="flex items-center gap-2 bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg font-bold text-sm">
                                <Icon path={Icons.LogOut} className="w-4 h-4" /> Keluar
                            </button>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        {loading ? (
                            <div className="p-12 text-center text-slate-500">Memuat data...</div>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-slate-50 text-slate-500 uppercase font-bold text-xs border-b">
                                        <tr>
                                            <th className="p-4">Tanggal</th>
                                            <th className="p-4">Nama Siswa</th>
                                            <th className="p-4">Kelas</th>
                                            <th className="p-4 text-center">Absen</th>
                                            <th className="p-4 text-center">Nilai</th>
                                            <th className="p-4 text-center">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {results.length === 0 ? (
                                            <tr><td colSpan="6" className="p-8 text-center text-slate-400 italic">Belum ada data ujian masuk.</td></tr>
                                        ) : results.map((res, i) => (
                                            <tr key={i} className="hover:bg-slate-50 transition">
                                                <td className="p-4 text-slate-500 whitespace-nowrap">{new Date(res.created_at || res.date).toLocaleString()}</td>
                                                <td className="p-4 font-bold text-slate-800">{res.name}</td>
                                                <td className="p-4">{res.kelas}</td>
                                                <td className="p-4 text-center">{res.absen}</td>
                                                <td className="p-4 text-center">
                                                    <span className={`px-2 py-1 rounded font-bold text-xs ${res.score >= 75 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                        {res.score}
                                                    </span>
                                                </td>
                                                <td className="p-4 text-center">
                                                    <button onClick={() => setSelectedResult(res.id)} className="text-indigo-600 hover:text-indigo-800 font-medium text-xs flex items-center justify-center gap-1 mx-auto">
                                                        <Icon path={Icons.Eye} className="w-4 h-4" /> Lihat Jawaban
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                    
                    {!supabase && (
                        <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm">
                            <strong>Info Mode Demo:</strong> Anda belum memasukkan URL Supabase di kodingan. Data saat ini hanya disimpan di Local Storage browser ini saja. Edit file HTML baris 48 untuk koneksi database.
                        </div>
                    )}

                    {selectedResult && (
                        <ViewDetailModal 
                            resultId={selectedResult} 
                            onClose={() => setSelectedResult(null)} 
                        />
                    )}
                </div>
            );
        }

        // ==========================================
        // MAIN APP CONTROLLER
        // ==========================================

        function App() {
            const [view, setView] = useState('login'); 
            const [user, setUser] = useState(null);
            const [questions, setQuestions] = useState([]);
            const [answers, setAnswers] = useState({});
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(40 * 60);
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => {
                if (view === 'exam' && timeLeft > 0) {
                    const timer = setInterval(() => setTimeLeft(prev => prev - 1), 1000);
                    return () => clearInterval(timer);
                } else if (timeLeft === 0 && view === 'exam') {
                    submitExam();
                }
            }, [timeLeft, view]);

            const handleLogin = (name, role, password, extraData) => {
                if (role === 'admin') {
                    if (password === 'admin123') {
                        setUser({ name: 'Guru Admin', role: 'admin' });
                        setView('admin');
                    } else {
                        alert("Password Salah!");
                    }
                } else {
                    setUser({ name, role, ...extraData });
                    setView('dashboard');
                }
            };

            const startExam = () => {
                // 1. Group by Category
                const mcPool = INITIAL_QUESTIONS.filter(q => q.category === 'mc');
                const bsPool = INITIAL_QUESTIONS.filter(q => q.category === 'bs');
                const matchPool = INITIAL_QUESTIONS.filter(q => q.category === 'match');
                const essayPool = INITIAL_QUESTIONS.filter(q => q.category === 'essay');

                // 2. Shuffle Each Pool Independently
                const shuffledMC = shuffleArray(mcPool);
                const shuffledBS = shuffleArray(bsPool);
                const shuffledMatch = shuffleArray(matchPool);
                const shuffledEssay = shuffleArray(essayPool);

                // 3. Select Questions (Total 25)
                // - Bagian 1: MC (8 Soal)
                // - Bagian 2: BS (2 Soal) + Match (8 Soal)
                // - Bagian 3: Essay (7 Soal)
                const selectedMC = shuffledMC.slice(0, 8);
                const selectedBS = shuffledBS.slice(0, 2);
                const selectedMatch = shuffledMatch.slice(0, 8);
                const selectedEssay = shuffledEssay.slice(0, 7);

                // 4. Combine in Strict Order: MC -> BS -> Match -> Essay
                const examQuestions = [
                    ...selectedMC,
                    ...selectedBS,
                    ...selectedMatch,
                    ...selectedEssay
                ];

                setQuestions(examQuestions);
                setTimeLeft(40 * 60);
                setView('exam');
            };

            const submitExam = async () => {
                setIsSubmitting(true);
                
                // 1. Scoring Logic
                let pgScore = 0;
                let essayScore = 0;
                const scorePerPg = 60 / questions.filter(q => q.type === 'choice').length;
                const scorePerEssay = 40 / questions.filter(q => q.type === 'essay').length;
                
                // Array untuk menampung detail jawaban yang akan disimpan ke DB
                const answersDetail = [];

                // Proses PG
                questions.filter(q => q.type === 'choice').forEach(q => {
                    const isCorrect = answers[q.id] === q.correctAnswer;
                    if (isCorrect) pgScore += scorePerPg;
                    
                    answersDetail.push({
                        question_id: q.id,
                        question_type: 'choice',
                        question_text: q.question,
                        student_answer: q.options[answers[q.id]] || "Tidak Dijawab", // Simpan teks jawaban
                        correct_answer: q.options[q.correctAnswer],
                        is_correct: isCorrect,
                        score: isCorrect ? Math.round(scorePerPg) : 0,
                        feedback: null
                    });
                });

                // Proses Essay (AI Simulation)
                const essayQs = questions.filter(q => q.type === 'essay');
                for (let q of essayQs) {
                    const result = await simulateAIAnalysis(answers[q.id] || "", q.keywords, q.minKeywords);
                    const realScore = (result.score / 100) * scorePerEssay;
                    essayScore += realScore;

                    answersDetail.push({
                        question_id: q.id,
                        question_type: 'essay',
                        question_text: q.question,
                        student_answer: answers[q.id] || "Tidak Dijawab",
                        correct_answer: "Kata kunci: " + q.keywords.join(", "),
                        is_correct: result.score > 50,
                        score: Math.round(realScore),
                        feedback: result.feedback
                    });
                }

                const finalScore = Math.round(pgScore + essayScore);
                setScore(finalScore);

                // 2. Simpan ke Database
                if (supabase) {
                    // A. Simpan Header (Rekap)
                    const { data: resultData, error: resultError } = await supabase
                        .from('exam_results')
                        .insert([{
                            name: user.name,
                            kelas: user.kelas,
                            absen: user.absen,
                            score: finalScore,
                            detail: { pg: pgScore, essay: essayScore }
                        }])
                        .select(); // Penting: select() untuk mendapatkan ID yang baru dibuat

                    if (!resultError && resultData && resultData.length > 0) {
                        const examId = resultData[0].id;
                        
                        // B. Simpan Detail Jawaban (Bulk Insert)
                        const finalAnswersPayload = answersDetail.map(ans => ({
                            exam_result_id: examId,
                            ...ans
                        }));

                        await supabase.from('student_answers').insert(finalAnswersPayload);
                    }
                } else {
                    // Fallback Local Storage
                    const localResults = JSON.parse(localStorage.getItem('cbt_local_results') || '[]');
                    localResults.push({
                        id: Date.now(), // Fake ID
                        name: user.name,
                        kelas: user.kelas,
                        absen: user.absen,
                        score: finalScore,
                        date: new Date().toISOString()
                    });
                    localStorage.setItem('cbt_local_results', JSON.stringify(localResults));
                }

                setIsSubmitting(false);
                setView('result');
            };

            return (
                <div className="min-h-screen">
                    {view === 'login' && <LoginScreen onLogin={handleLogin} />}
                    {view === 'dashboard' && <StudentDashboard user={user} onStart={startExam} />}
                    {view === 'exam' && <ExamInterface questions={questions} answers={answers} setAnswers={setAnswers} onSubmit={submitExam} timeLeft={timeLeft} isSubmitting={isSubmitting} />}
                    {view === 'result' && <ResultScreen score={score} user={user} onHome={() => setView('login')} />}
                    {view === 'admin' && <AdminPanel onLogout={() => setView('login')} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
