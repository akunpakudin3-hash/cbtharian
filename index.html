<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT Informatika - Jejak Digital</title>
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. REACT & REACT DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. BABEL (Untuk JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. SUPABASE JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- 5. SHEETJS (Untuk Export Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <!-- 6. FONT (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .scroll-smooth { scroll-behavior: smooth; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // KONFIGURASI SUPABASE (WAJIB DIISI)
        // ==========================================
        const SUPABASE_URL = ""; // Isi URL Project Supabase Anda
        const SUPABASE_ANON_KEY = ""; // Isi Anon Key Supabase Anda
        
        // Inisialisasi Client Supabase
        let supabase = null;
        if (SUPABASE_URL && SUPABASE_ANON_KEY) {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        const { useState, useEffect } = React;

        // --- ICON COMPONENTS ---
        // Fixed: Added Fragments <></> for icons with multiple paths
        const Icon = ({ path, className, fill="none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Brain: <><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6 6.5"/><path d="M3.477 12.578c.25.3.56.548.9.721"/><path d="M20.52 12.578c-.25.3-.56.548-.9.721"/></>,
            User: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
            Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
            Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
            FileText: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>,
            CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
            XCircle: <><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></>,
            LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>,
            GraduationCap: <><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></>,
            Hash: <><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></>,
            Save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>,
            Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>,
            Loader: <path d="M21 12a9 9 0 1 1-6.219-8.56"/>,
            Eye: <><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></>,
            X: <><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>
        };

        // --- BANK SOAL (40 Soal) ---
        const INITIAL_QUESTIONS = [
             { id: 1, type: 'choice', question: "1. (Analisis Kasus) Rina gugur seleksi beasiswa karena komentar kasar di akun anonim lama. Kesimpulan?", options: ["Panitia melanggar privasi.", "Jejak digital bersifat abadi dan bisa dilacak.", "Rina harusnya hapus akun.", "Medsos bukan karakter asli."], correctAnswer: 1 },
             { id: 2, type: 'choice', question: "2. (Keamanan) Bahaya memposting foto Boarding Pass tiket pesawat?", options: ["Teman iri.", "Barcode mengandung data pribadi (NIK) yg bisa dicuri.", "Tiket batal otomatis.", "Foto pecah."], correctAnswer: 1 },
             { id: 3, type: 'choice', question: "3. (Teknis) Fakta tentang 'Incognito Mode'?", options: ["Sembunyi dari ISP.", "Lokasi GPS mati.", "Hanya tidak simpan history di perangkat lokal.", "Anti virus."], correctAnswer: 2 },
             { id: 4, type: 'choice', question: "4. (Dampak) Bahaya 'Sharenting' (Orang tua share foto anak)?", options: ["Anak jadi artis.", "Hilangnya hak privasi & risiko penyalahgunaan foto.", "Memori penuh.", "Anak sombong."], correctAnswer: 1 },
             { id: 5, type: 'choice', question: "5. (Konsep) Email lamaran (A) & History Maps (B). Jenis jejak?", options: ["A=Pasif, B=Aktif.", "A=Aktif, B=Pasif.", "Semua Pasif.", "Semua Aktif."], correctAnswer: 1 },
             { id: 6, type: 'choice', question: "6. (Evaluasi) Link 'kemdikbud-kuota.xyz' di WA. Sikap?", options: ["Klik.", "Share.", "Analisis domain (bukan .go.id = Phishing).", "Isi data."], correctAnswer: 2 },
             { id: 7, type: 'choice', question: "7. Kenapa hapus postingan tidak jamin jejak hilang?", options: ["Tombol rusak.", "Ada screenshot orang lain / backup server.", "Memori tak terbatas.", "Dilarang."], correctAnswer: 1 },
             { id: 8, type: 'choice', question: "8. Siapa bertanggung jawab hukum atas cyberbullying akun palsu?", options: ["Medsos.", "Sekolah.", "Pemilik akun (pelaku).", "Korban."], correctAnswer: 2 },
             { id: 9, type: 'choice', question: "9. Cara bersihkan jejak digital sebelum lamar kerja?", options: ["Hapus semua akun.", "Self-Googling & hapus konten negatif.", "Ganti nama.", "Spam status positif."], correctAnswer: 1 },
             { id: 10, type: 'choice', question: "10. Fungsi 'Cookies' browser?", options: ["Curi password.", "Simpan preferensi (login/belanja).", "Lambatkan PC.", "Hapus history."], correctAnswer: 1 },
             { id: 11, type: 'choice', question: "11. Risiko WiFi publik untuk M-Banking?", options: ["Lambat.", "Sniffing (Penyadapan data).", "Bayar.", "Boros baterai."], correctAnswer: 1 },
             { id: 12, type: 'choice', question: "12. Posting foto aib teman tanpa izin?", options: ["Lucu.", "Langgar etika (Consent).", "Boleh asal tidak SARA.", "Boleh asal dihapus."], correctAnswer: 1 },
             { id: 13, type: 'choice', question: "13. Kenapa iklan medsos sesuai obrolan kita?", options: ["Kebetulan.", "Algoritma profiling (Targeted Ads).", "Sadap kamera.", "Admin manual."], correctAnswer: 1 },
             { id: 14, type: 'choice', question: "14. Cegah Doxing (sebar data pribadi)?", options: ["Jangan punya teman.", "Batasi info pribadi di profil publik.", "Balas dendam.", "Lapor polisi."], correctAnswer: 1 },
             { id: 15, type: 'choice', question: "15. 'Jejak Digital = Mata Uang Baru' artinya?", options: ["Bisa belanja.", "Reputasi online bernilai tinggi untuk karir.", "Dapat uang tunai.", "Bayar online."], correctAnswer: 1 },
             { id: 16, type: 'choice', question: "16. Apa itu 2FA (Two-Factor Authentication)?", options: ["2 Password sama.", "2 HP.", "Password + Kode OTP (Lapis kedua).", "Login 2 orang."], correctAnswer: 2 },
             { id: 17, type: 'choice', question: "17. Ciri website aman transaksi (SSL)?", options: ["Banyak iklan.", "HTTPS & Gembok.", "Warna biru.", "Minta PIN."], correctAnswer: 1 },
             { id: 18, type: 'choice', question: "18. Membanjiri pesan sampah disebut?", options: ["Phishing", "Spamming", "Hacking", "Skimming"], correctAnswer: 1 },
             { id: 19, type: 'choice', question: "19. Mengaku karya orang lain sebagai milik sendiri?", options: ["Inspirasi", "Plagiarisme", "Kolaborasi", "Fair Use"], correctAnswer: 1 },
             { id: 20, type: 'choice', question: "20. Password paling kuat?", options: ["admin123", "Nama123", "P4ssW0rd!", "Kombinasi Rumit (!@#)"], correctAnswer: 3 },
             { id: 21, type: 'choice', question: "21. (B/S) Mode Pesawat menghapus jejak digital internal HP.", options: ["Benar", "Salah"], correctAnswer: 1 },
             { id: 22, type: 'choice', question: "22. (B/S) Tutup tab = Hapus history permanen.", options: ["Benar", "Salah"], correctAnswer: 1 },
             { id: 23, type: 'choice', question: "23. (B/S) Password sama semua akun itu aman.", options: ["Benar", "Salah"], correctAnswer: 1 },
             { id: 24, type: 'choice', question: "24. (B/S) Email 5 tahun lalu masih tersimpan di server.", options: ["Benar", "Salah"], correctAnswer: 0 },
             { id: 25, type: 'choice', question: "25. (B/S) VPN mengenkripsi koneksi internet.", options: ["Benar", "Salah"], correctAnswer: 0 },
             { id: 26, type: 'choice', question: "26. Cyberstalking adalah...", options: ["Main game.", "Menguntit aktivitas online orang secara obsesif.", "Belajar online.", "Belanja."], correctAnswer: 1 },
             { id: 27, type: 'choice', question: "27. Langkah pertama jika akun di-hack?", options: ["Buat baru.", "Diam.", "Reset password & nyalakan 2FA.", "Lapor polisi."], correctAnswer: 2 },
             { id: 28, type: 'choice', question: "28. Digital Wellness adalah...", options: ["Servis HP.", "Keseimbangan hidup & teknologi.", "Aplikasi sehat.", "Olahraga."], correctAnswer: 1 },
             { id: 29, type: 'choice', question: "29. Risiko klik 'Setuju' tanpa baca S&K?", options: ["Meledak.", "Tak sadar beri izin data ke perusahaan.", "Cepat.", "Aman."], correctAnswer: 1 },
             { id: 30, type: 'choice', question: "30. Sebar Hoax langgar prinsip...", options: ["Kreativitas", "Literasi & Etika", "Kecepatan", "Ekonomi"], correctAnswer: 1 },
             // ESSAY
             { id: 31, type: 'essay', question: "31. Analisis mengapa universitas cek jejak digital pelamar?", keywords: ["karakter", "reputasi", "integritas", "etika", "citra"], minKeywords: 3, maxScore: 10 },
             { id: 32, type: 'essay', question: "32. Jelaskan dilema Kenyamanan vs Privasi pada GPS Ojol!", keywords: ["mudah", "lacak", "privasi", "data lokasi", "disalahgunakan"], minKeywords: 3, maxScore: 10 },
             { id: 33, type: 'essay', question: "33. 3 Langkah jika ada akun palsu (impersonation) pakai namamu?", keywords: ["lapor", "report", "blokir", "klarifikasi", "screenshot"], minKeywords: 3, maxScore: 10 },
             { id: 34, type: 'essay', question: "34. Apakah jejak pasif lebih bahaya dari aktif? Argumenmu!", keywords: ["tanpa sadar", "profiling", "tersembunyi", "sadar", "kontrol"], minKeywords: 3, maxScore: 10 },
             { id: 35, type: 'essay', question: "35. Slogan 'Think Before You Post' & maknanya?", keywords: ["pikir", "masa depan", "bijak", "saring", "jejak"], minKeywords: 2, maxScore: 10 },
             { id: 36, type: 'essay', question: "36. Kenapa dilarang pakai Tanggal Lahir sbg PIN?", keywords: ["mudah ditebak", "data umum", "lemah", "identitas"], minKeywords: 3, maxScore: 10 },
             { id: 37, type: 'essay', question: "37. Dampak hukum Hate Speech (UU ITE)?", keywords: ["hukum", "penjara", "denda", "uu ite", "pencemaran"], minKeywords: 3, maxScore: 10 },
             { id: 38, type: 'essay', question: "38. Beda Block vs Report?", keywords: ["block", "tutup akses", "report", "lapor", "pelanggaran"], minKeywords: 3, maxScore: 10 },
             { id: 39, type: 'essay', question: "39. Terima file .exe mencurigakan di email, sikapmu?", keywords: ["virus", "malware", "jangan buka", "hapus"], minKeywords: 2, maxScore: 10 },
             { id: 40, type: 'essay', question: "40. Opini: Sekolah boleh sita HP untuk cek chat bullying?", keywords: ["privasi", "hak", "aturan", "bullying", "batas"], minKeywords: 2, maxScore: 10 },
        ];

        // --- UTILS ---
        const shuffleArray = (array) => {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        };

        const simulateAIAnalysis = async (answer, keywords, minKeywords) => {
            return new Promise((resolve) => {
                setTimeout(() => {
                    if (!answer || answer.trim().length < 5) {
                        resolve({ score: 0, feedback: "Jawaban terlalu singkat." });
                        return;
                    }
                    const lowerAnswer = answer.toLowerCase();
                    const matchCount = keywords.filter(k => lowerAnswer.includes(k)).length;
                    
                    let score = 30; // Base score
                    let feedback = "Kurang lengkap.";
                    
                    if (matchCount >= minKeywords) {
                        score = 100;
                        feedback = "Sangat Baik! Argumen lengkap.";
                    } else if (matchCount >= Math.ceil(minKeywords / 2)) {
                        score = 70;
                        feedback = "Cukup baik, perlu lebih detail.";
                    }
                    
                    resolve({ score, feedback });
                }, 1000);
            });
        };

        // ==========================================
        // COMPONENTS
        // ==========================================

        function LoginScreen({ onLogin }) {
            const [role, setRole] = useState('student');
            const [name, setName] = useState('');
            const [password, setPassword] = useState('');
            const [kelas, setKelas] = useState('');
            const [absen, setAbsen] = useState('');

            const handleStudentLogin = () => {
                if (name && kelas && absen) {
                    onLogin(name.toUpperCase(), 'student', null, { kelas, absen });
                } else {
                    alert("Mohon lengkapi Nama, Kelas, dan No Absen!");
                }
            };

            return (
                <div className="flex justify-center items-center min-h-[80vh]">
                    <div className="bg-white p-8 rounded-xl shadow-xl w-full max-w-md border border-slate-200">
                        <div className="text-center mb-6">
                            <div className="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-3 text-indigo-600">
                                <Icon path={Icons.Brain} className="w-8 h-8" />
                            </div>
                            <h2 className="text-2xl font-bold text-slate-800">CBT Informatika</h2>
                            <p className="text-slate-500">Jejak Digital & Keamanan Siber</p>
                        </div>

                        <div className="flex bg-slate-100 p-1 rounded-lg mb-6">
                            <button onClick={() => setRole('student')} className={`flex-1 py-2 text-sm font-medium rounded-md transition ${role === 'student' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>Siswa</button>
                            <button onClick={() => setRole('admin')} className={`flex-1 py-2 text-sm font-medium rounded-md transition ${role === 'admin' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>Guru Admin</button>
                        </div>

                        {role === 'student' ? (
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Lengkap</label>
                                    <div className="relative">
                                        <div className="absolute left-3 top-2.5 text-slate-400"><Icon path={Icons.User} className="w-5 h-5"/></div>
                                        <input type="text" value={name} onChange={e => setName(e.target.value.toUpperCase())} className="w-full pl-10 p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none uppercase" placeholder="NAMA SISWA" />
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Kelas</label>
                                        <div className="relative">
                                            <div className="absolute left-3 top-2.5 text-slate-400"><Icon path={Icons.GraduationCap} className="w-5 h-5"/></div>
                                            <select value={kelas} onChange={e => setKelas(e.target.value)} className="w-full pl-10 p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                                                <option value="">Pilih</option>
                                                <option value="VIII-A">VIII-A</option>
                                                <option value="VIII-B">VIII-B</option>
                                                <option value="VIII-C">VIII-C</option>
                                                <option value="VIII-D">VIII-D</option>
                                                <option value="VIII-E">VIII-E</option>
                                                <option value="VIII-F">VIII-F</option>
                                                <option value="VIII-G">VIII-G</option>
                                                <option value="VIII-H">VIII-H</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Absen</label>
                                        <div className="relative">
                                            <div className="absolute left-3 top-2.5 text-slate-400"><Icon path={Icons.Hash} className="w-5 h-5"/></div>
                                            <input type="number" value={absen} onChange={e => setAbsen(e.target.value)} className="w-full pl-10 p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="1-40" />
                                        </div>
                                    </div>
                                </div>
                                <button onClick={handleStudentLogin} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-bold shadow-lg transition transform hover:scale-[1.02]">Mulai Ujian</button>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Password Admin</label>
                                    <div className="relative">
                                        <div className="absolute left-3 top-2.5 text-slate-400"><Icon path={Icons.Lock} className="w-5 h-5"/></div>
                                        <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full pl-10 p-2.5 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Masukkan Kode..." />
                                    </div>
                                </div>
                                <button onClick={() => onLogin('Admin', 'admin', password)} className="w-full bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-lg font-bold shadow-lg">Masuk Panel Guru</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function StudentDashboard({ user, onStart }) {
            return (
                <div className="max-w-2xl mx-auto mt-12 bg-white p-8 rounded-xl shadow-lg border border-slate-200 text-center">
                    <div className="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600">
                        <Icon path={Icons.User} className="w-10 h-10" />
                    </div>
                    <h2 className="text-2xl font-bold text-slate-800">Halo, {user.name}</h2>
                    <p className="text-slate-500 mb-6 font-medium">Kelas {user.kelas} | No. Absen {user.absen}</p>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-left">
                         <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <span className="text-xs font-bold text-slate-400 uppercase">Jumlah Soal</span>
                            <p className="text-xl font-bold text-slate-800">25 Butir</p>
                         </div>
                         <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <span className="text-xs font-bold text-slate-400 uppercase">Waktu</span>
                            <p className="text-xl font-bold text-slate-800">40 Menit</p>
                         </div>
                         <div className="p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <span className="text-xs font-bold text-slate-400 uppercase">Sistem</span>
                            <p className="text-xl font-bold text-slate-800">Acak (Random)</p>
                         </div>
                    </div>

                    <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200 text-yellow-800 text-sm text-left mb-6">
                        <strong>Perhatian:</strong> Soal akan diacak dari bank soal utama. Kerjakan sendiri dengan jujur. Waktu akan berjalan mundur otomatis.
                    </div>

                    <button onClick={onStart} className="px-8 py-3 bg-indigo-600 text-white rounded-full font-bold shadow-lg hover:bg-indigo-700 transition w-full md:w-auto">
                        Mulai Mengerjakan
                    </button>
                </div>
            );
        }

        function ExamInterface({ questions, answers, setAnswers, onSubmit, timeLeft, isSubmitting }) {
            const formatTime = (s) => {
                const m = Math.floor(s / 60);
                const sc = s % 60;
                return `${m}:${sc < 10 ? '0' : ''}${sc}`;
            };

            if (isSubmitting) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-[60vh]">
                        <div className="animate-spin text-indigo-600 mb-4"><Icon path={Icons.Loader} className="w-12 h-12" /></div>
                        <h3 className="text-xl font-bold text-slate-700">Sedang Mengirim Jawaban...</h3>
                        <p className="text-slate-500">Mohon jangan tutup halaman ini.</p>
                    </div>
                );
            }

            return (
                <div className="flex flex-col md:flex-row gap-6 items-start max-w-6xl mx-auto p-4">
                    {/* Main Question Area */}
                    <div className="flex-1 w-full space-y-8 pb-20">
                        {questions.map((q, idx) => (
                            <div key={q.id} id={`q-${idx}`} className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 scroll-mt-24">
                                <div className="flex gap-4 mb-4">
                                    <span className="flex-shrink-0 w-8 h-8 bg-indigo-100 text-indigo-700 font-bold rounded flex items-center justify-center text-sm">{idx + 1}</span>
                                    <div className="flex-1">
                                        <p className="font-medium text-lg text-slate-800">{q.question}</p>
                                        {q.type === 'essay' && <span className="inline-block mt-1 text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded">Soal Uraian</span>}
                                    </div>
                                </div>

                                {q.type === 'choice' ? (
                                    <div className="space-y-2 pl-12">
                                        {q.options.map((opt, oIdx) => (
                                            <button 
                                                key={oIdx}
                                                onClick={() => setAnswers({...answers, [q.id]: oIdx})}
                                                className={`w-full text-left p-3 rounded-lg border transition flex items-center gap-3 ${answers[q.id] === oIdx ? 'bg-indigo-50 border-indigo-500 text-indigo-800 font-medium' : 'hover:bg-slate-50 border-slate-200 text-slate-600'}`}
                                            >
                                                <div className={`w-4 h-4 rounded-full border flex items-center justify-center flex-shrink-0 ${answers[q.id] === oIdx ? 'border-indigo-500 bg-indigo-500' : 'border-slate-300'}`}>
                                                    {answers[q.id] === oIdx && <div className="w-1.5 h-1.5 bg-white rounded-full"></div>}
                                                </div>
                                                {opt}
                                            </button>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="pl-12">
                                        <textarea 
                                            value={answers[q.id] || ''}
                                            onChange={e => setAnswers({...answers, [q.id]: e.target.value})}
                                            className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                                            rows="4"
                                            placeholder="Ketik jawaban uraian Anda di sini..."
                                        ></textarea>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {/* Sidebar */}
                    <div className="w-full md:w-72 flex-shrink-0 space-y-4 sticky top-4">
                        <div className="bg-white p-4 rounded-xl shadow border border-slate-200 text-center">
                            <span className="text-xs font-bold text-slate-400 uppercase flex items-center justify-center gap-1 mb-1">
                                <Icon path={Icons.Clock} className="w-3 h-3"/> Sisa Waktu
                            </span>
                            <div className={`text-3xl font-mono font-bold ${timeLeft < 300 ? 'text-red-500 animate-pulse' : 'text-slate-800'}`}>
                                {formatTime(timeLeft)}
                            </div>
                        </div>

                        <div className="bg-white p-4 rounded-xl shadow border border-slate-200">
                            <h4 className="font-bold text-sm text-slate-700 mb-3">Navigasi Soal</h4>
                            <div className="grid grid-cols-5 gap-2">
                                {questions.map((q, idx) => (
                                    <a 
                                        key={q.id}
                                        href={`#q-${idx}`}
                                        className={`aspect-square flex items-center justify-center rounded text-sm font-bold transition ${answers[q.id] !== undefined ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}
                                    >
                                        {idx + 1}
                                    </a>
                                ))}
                            </div>
                        </div>
                        
                        <button 
                            onClick={() => { if(confirm("Yakin ingin mengumpulkan ujian?")) onSubmit(); }}
                            className="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold shadow-lg transition"
                        >
                            Kumpulkan Jawaban
                        </button>
                    </div>
                </div>
            );
        }

        function ResultScreen({ score, user, onHome }) {
            const isLulus = score >= 75;
            return (
                <div className="flex justify-center items-center min-h-[80vh] p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg text-center border border-slate-100 relative overflow-hidden">
                        <div className={`absolute top-0 left-0 w-full h-2 ${isLulus ? 'bg-green-500' : 'bg-red-500'}`}></div>
                        <div className={`w-20 h-20 rounded-full mx-auto flex items-center justify-center mb-6 ${isLulus ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                            <Icon path={isLulus ? Icons.CheckCircle : Icons.XCircle} className="w-10 h-10" />
                        </div>
                        
                        <h2 className="text-3xl font-bold text-slate-800 mb-2">{isLulus ? "Selamat! Anda Lulus" : "Belum Lulus"}</h2>
                        <p className="text-slate-500 mb-6">Terima kasih telah mengikuti ujian.</p>
                        
                        <div className="bg-slate-50 p-6 rounded-xl border border-slate-200 mb-8">
                            <div className="flex justify-between items-center mb-2 text-sm text-slate-500">
                                <span>{user.name}</span>
                                <span>{user.kelas}</span>
                            </div>
                            <div className="text-6xl font-bold text-slate-800">{score}</div>
                            <div className="text-xs text-slate-400 mt-1 uppercase tracking-wide">Nilai Akhir</div>
                        </div>

                        <button onClick={onHome} className="w-full bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-lg font-bold">Kembali ke Halaman Login</button>
                    </div>
                </div>
            );
        }

        function ViewDetailModal({ resultId, onClose }) {
            const [details, setDetails] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                fetchDetails();
            }, []);

            const fetchDetails = async () => {
                if (supabase) {
                    const { data, error } = await supabase
                        .from('student_answers')
                        .select('*')
                        .eq('exam_result_id', resultId);
                    if (!error) setDetails(data);
                }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                        <div className="p-6 border-b flex justify-between items-center bg-slate-50 rounded-t-xl">
                            <h3 className="font-bold text-lg text-slate-800">Detail Jawaban Siswa</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-red-500"><Icon path={Icons.X} className="w-6 h-6"/></button>
                        </div>
                        <div className="overflow-y-auto p-6 space-y-6 flex-1">
                            {loading ? <p className="text-center">Memuat...</p> : details.length === 0 ? <p className="text-center text-slate-500">Tidak ada detail jawaban (Mode Offline/Lama).</p> : (
                                details.map((ans, idx) => (
                                    <div key={idx} className="border-b pb-4 last:border-0">
                                        <div className="flex justify-between mb-2">
                                            <span className="font-bold text-slate-700">Soal {idx + 1} ({ans.question_type === 'choice' ? 'PG' : 'Essay'})</span>
                                            <span className={`px-2 py-0.5 text-xs rounded font-bold ${ans.is_correct || ans.score > 5 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                Skor: {ans.score}
                                            </span>
                                        </div>
                                        <p className="text-sm text-slate-600 mb-2">{ans.question_text}</p>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                            <div className="bg-slate-50 p-3 rounded">
                                                <p className="text-xs text-slate-400 uppercase font-bold mb-1">Jawaban Siswa</p>
                                                <p className="text-slate-800">{ans.student_answer || "-"}</p>
                                            </div>
                                            {ans.question_type === 'choice' ? (
                                                <div className="bg-green-50 p-3 rounded">
                                                    <p className="text-xs text-green-600 uppercase font-bold mb-1">Kunci Jawaban</p>
                                                    <p className="text-green-800">{ans.correct_answer}</p>
                                                </div>
                                            ) : (
                                                <div className="bg-blue-50 p-3 rounded">
                                                    <p className="text-xs text-blue-600 uppercase font-bold mb-1">Feedback AI</p>
                                                    <p className="text-blue-800">{ans.feedback || "-"}</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function AdminPanel({ onLogout }) {
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedResult, setSelectedResult] = useState(null);

            useEffect(() => {
                fetchResults();
            }, []);

            const fetchResults = async () => {
                setLoading(true);
                if (supabase) {
                    try {
                        const { data, error } = await supabase
                            .from('exam_results')
                            .select('*')
                            .order('created_at', { ascending: false });
                        
                        if (error) throw error;
                        setResults(data);
                    } catch (err) {
                        alert("Gagal ambil data Supabase: " + err.message);
                        setResults(JSON.parse(localStorage.getItem('cbt_local_results') || '[]'));
                    }
                } else {
                    const localData = JSON.parse(localStorage.getItem('cbt_local_results') || '[]');
                    setResults(localData);
                }
                setLoading(false);
            };

            const downloadExcel = () => {
                const worksheet = XLSX.utils.json_to_sheet(results.map(r => ({
                    Tanggal: new Date(r.created_at || r.date).toLocaleString(),
                    Nama: r.name,
                    Kelas: r.kelas,
                    Absen: r.absen,
                    Nilai: r.score
                })));
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Nilai Siswa");
                XLSX.writeFile(workbook, "Rekap_Nilai_CBT.xlsx");
            };

            return (
                <div className="max-w-6xl mx-auto p-6">
                    <div className="flex justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800">Panel Guru</h2>
                            <p className="text-slate-500 text-sm">Rekapitulasi Hasil Ujian</p>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={downloadExcel} className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold text-sm">
                                <Icon path={Icons.Download} className="w-4 h-4" /> Download Excel
                            </button>
                            <button onClick={onLogout} className="flex items-center gap-2 bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg font-bold text-sm">
                                <Icon path={Icons.LogOut} className="w-4 h-4" /> Keluar
                            </button>
                        </div>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        {loading ? (
                            <div className="p-12 text-center text-slate-500">Memuat data...</div>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm">
                                    <thead className="bg-slate-50 text-slate-500 uppercase font-bold text-xs border-b">
                                        <tr>
                                            <th className="p-4">Tanggal</th>
                                            <th className="p-4">Nama Siswa</th>
                                            <th className="p-4">Kelas</th>
                                            <th className="p-4 text-center">Absen</th>
                                            <th className="p-4 text-center">Nilai</th>
                                            <th className="p-4 text-center">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {results.length === 0 ? (
                                            <tr><td colSpan="6" className="p-8 text-center text-slate-400 italic">Belum ada data ujian masuk.</td></tr>
                                        ) : results.map((res, i) => (
                                            <tr key={i} className="hover:bg-slate-50 transition">
                                                <td className="p-4 text-slate-500 whitespace-nowrap">{new Date(res.created_at || res.date).toLocaleString()}</td>
                                                <td className="p-4 font-bold text-slate-800">{res.name}</td>
                                                <td className="p-4">{res.kelas}</td>
                                                <td className="p-4 text-center">{res.absen}</td>
                                                <td className="p-4 text-center">
                                                    <span className={`px-2 py-1 rounded font-bold text-xs ${res.score >= 75 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                        {res.score}
                                                    </span>
                                                </td>
                                                <td className="p-4 text-center">
                                                    <button onClick={() => setSelectedResult(res.id)} className="text-indigo-600 hover:text-indigo-800 font-medium text-xs flex items-center justify-center gap-1 mx-auto">
                                                        <Icon path={Icons.Eye} className="w-4 h-4" /> Lihat Jawaban
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                    
                    {!supabase && (
                        <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm">
                            <strong>Info Mode Demo:</strong> Anda belum memasukkan URL Supabase di kodingan. Data saat ini hanya disimpan di Local Storage browser ini saja. Edit file HTML baris 48 untuk koneksi database.
                        </div>
                    )}

                    {selectedResult && (
                        <ViewDetailModal 
                            resultId={selectedResult} 
                            onClose={() => setSelectedResult(null)} 
                        />
                    )}
                </div>
            );
        }

        // ==========================================
        // MAIN APP CONTROLLER
        // ==========================================

        function App() {
            const [view, setView] = useState('login'); 
            const [user, setUser] = useState(null);
            const [questions, setQuestions] = useState([]);
            const [answers, setAnswers] = useState({});
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(40 * 60);
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => {
                if (view === 'exam' && timeLeft > 0) {
                    const timer = setInterval(() => setTimeLeft(prev => prev - 1), 1000);
                    return () => clearInterval(timer);
                } else if (timeLeft === 0 && view === 'exam') {
                    submitExam();
                }
            }, [timeLeft, view]);

            const handleLogin = (name, role, password, extraData) => {
                if (role === 'admin') {
                    if (password === 'admin123') {
                        setUser({ name: 'Guru Admin', role: 'admin' });
                        setView('admin');
                    } else {
                        alert("Password Salah!");
                    }
                } else {
                    setUser({ name, role, ...extraData });
                    setView('dashboard');
                }
            };

            const startExam = () => {
                const shuffled = shuffleArray(INITIAL_QUESTIONS);
                const selected = shuffled.slice(0, 25); 
                setQuestions(selected);
                setTimeLeft(40 * 60);
                setView('exam');
            };

            const submitExam = async () => {
                setIsSubmitting(true);
                
                // 1. Scoring Logic
                let pgScore = 0;
                let essayScore = 0;
                const scorePerPg = 60 / questions.filter(q => q.type === 'choice').length;
                const scorePerEssay = 40 / questions.filter(q => q.type === 'essay').length;
                
                // Array untuk menampung detail jawaban yang akan disimpan ke DB
                const answersDetail = [];

                // Proses PG
                questions.filter(q => q.type === 'choice').forEach(q => {
                    const isCorrect = answers[q.id] === q.correctAnswer;
                    if (isCorrect) pgScore += scorePerPg;
                    
                    answersDetail.push({
                        question_id: q.id,
                        question_type: 'choice',
                        question_text: q.question,
                        student_answer: q.options[answers[q.id]] || "Tidak Dijawab", // Simpan teks jawaban
                        correct_answer: q.options[q.correctAnswer],
                        is_correct: isCorrect,
                        score: isCorrect ? Math.round(scorePerPg) : 0,
                        feedback: null
                    });
                });

                // Proses Essay (AI Simulation)
                const essayQs = questions.filter(q => q.type === 'essay');
                for (let q of essayQs) {
                    const result = await simulateAIAnalysis(answers[q.id] || "", q.keywords, q.minKeywords);
                    const realScore = (result.score / 100) * scorePerEssay;
                    essayScore += realScore;

                    answersDetail.push({
                        question_id: q.id,
                        question_type: 'essay',
                        question_text: q.question,
                        student_answer: answers[q.id] || "Tidak Dijawab",
                        correct_answer: "Kata kunci: " + q.keywords.join(", "),
                        is_correct: result.score > 50,
                        score: Math.round(realScore),
                        feedback: result.feedback
                    });
                }

                const finalScore = Math.round(pgScore + essayScore);
                setScore(finalScore);

                // 2. Simpan ke Database
                if (supabase) {
                    // A. Simpan Header (Rekap)
                    const { data: resultData, error: resultError } = await supabase
                        .from('exam_results')
                        .insert([{
                            name: user.name,
                            kelas: user.kelas,
                            absen: user.absen,
                            score: finalScore,
                            detail: { pg: pgScore, essay: essayScore }
                        }])
                        .select(); // Penting: select() untuk mendapatkan ID yang baru dibuat

                    if (!resultError && resultData && resultData.length > 0) {
                        const examId = resultData[0].id;
                        
                        // B. Simpan Detail Jawaban (Bulk Insert)
                        const finalAnswersPayload = answersDetail.map(ans => ({
                            exam_result_id: examId,
                            ...ans
                        }));

                        await supabase.from('student_answers').insert(finalAnswersPayload);
                    }
                } else {
                    // Fallback Local Storage
                    const localResults = JSON.parse(localStorage.getItem('cbt_local_results') || '[]');
                    localResults.push({
                        id: Date.now(), // Fake ID
                        name: user.name,
                        kelas: user.kelas,
                        absen: user.absen,
                        score: finalScore,
                        date: new Date().toISOString()
                    });
                    localStorage.setItem('cbt_local_results', JSON.stringify(localResults));
                }

                setIsSubmitting(false);
                setView('result');
            };

            return (
                <div className="min-h-screen">
                    {view === 'login' && <LoginScreen onLogin={handleLogin} />}
                    {view === 'dashboard' && <StudentDashboard user={user} onStart={startExam} />}
                    {view === 'exam' && <ExamInterface questions={questions} answers={answers} setAnswers={setAnswers} onSubmit={submitExam} timeLeft={timeLeft} isSubmitting={isSubmitting} />}
                    {view === 'result' && <ResultScreen score={score} user={user} onHome={() => setView('login')} />}
                    {view === 'admin' && <AdminPanel onLogout={() => setView('login')} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
