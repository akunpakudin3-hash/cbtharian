<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CBT Informatika - Standar Ujian</title>
    
    <!-- 1. LIBRARY -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <!-- 2. FONT (Inter - Standar & Jelas) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 3. CONFIG STYLE -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        cbtBlue: '#2563eb', // Indigo 600 equivalent
                        cbtDark: '#1e293b', // Slate 800
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #e2e8f0; font-size: 14px; }
        /* Scrollbar Tipis */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .question-text { font-size: 16px; line-height: 1.6; }
        .option-text { font-size: 14px; }
        
        /* Grid Navigasi */
        .nav-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
        
        /* Animasi */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.2s ease-out; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        // --- KONFIGURASI DATABASE ---
        const SUPABASE_URL = "https://qikeneczlyvbjprnhxyl.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpa2VuZWN6bHl2Ympwcm5oeHlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MDM1MTYsImV4cCI6MjA4NjE3OTUxNn0.qRdHiFNMOnxYDOLz9Q-CsistIrYn0GT7HXX4FNkD1d4"; 
        
        let supabaseClient = null;
        try {
            if (typeof supabase !== 'undefined') supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) { console.error("Supabase Error:", e); }

        const { useState, useEffect } = React;

        // --- ICON (SVG Simple) ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );

        const Icons = {
            User: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
            Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
            Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
            Check: <polyline points="20 6 9 17 4 12"/>,
            X: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
            Menu: <><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></>,
            Left: <polyline points="15 18 9 12 15 6"/>,
            Right: <polyline points="9 18 15 12 9 6"/>,
            List: <><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></>,
            LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>,
            Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>,
            Loader: <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83" />
        };

        // --- DATA SOAL ---
        const INITIAL_QUESTIONS = [
            { id: 1, category: 'mc', type: 'choice', question: "Seorang pelamar kerja ditolak karena komentar kasar di akun anonim lamanya. Kesimpulan?", options: ["Panitia melanggar privasi.", "Jejak digital bersifat abadi.", "Rina harusnya hapus akun.", "Medsos bukan karakter asli."], correctAnswer: 1 },
            { id: 2, category: 'mc', type: 'choice', question: "Mengapa posting foto Boarding Pass berbahaya?", options: ["Bikin teman iri.", "Barcode mengandung data pribadi.", "Tiket batal otomatis.", "Foto pecah."], correctAnswer: 1 },
            { id: 3, category: 'mc', type: 'choice', question: "Fakta tentang Incognito Mode?", options: ["Sembunyi dari ISP.", "Lokasi GPS mati.", "Hanya tidak simpan history lokal.", "Anti virus."], correctAnswer: 2 },
            { id: 4, category: 'mc', type: 'choice', question: "Risiko utama Sharenting (Share foto anak)?", options: ["Anak jadi artis.", "Hilang privasi & risiko data.", "Memori penuh.", "Anak sombong."], correctAnswer: 1 },
            { id: 5, category: 'mc', type: 'choice', question: "Email lamaran (A) & History Maps (B). Jenis jejak?", options: ["A=Pasif, B=Aktif.", "A=Aktif, B=Pasif.", "Semua Pasif.", "Semua Aktif."], correctAnswer: 1 },
            { id: 6, category: 'mc', type: 'choice', question: "Ada link kemdikbud-kuota.xyz. Sikapmu?", options: ["Klik.", "Share.", "Analisis domain (Phishing).", "Isi data."], correctAnswer: 2 },
            { id: 7, category: 'mc', type: 'choice', question: "Kenapa hapus postingan tidak jamin hilang?", options: ["Tombol rusak.", "Ada screenshot/backup.", "Memori tak terbatas.", "Dilarang."], correctAnswer: 1 },
            { id: 8, category: 'mc', type: 'choice', question: "Siapa bertanggung jawab hukum cyberbullying?", options: ["Medsos.", "Sekolah.", "Pemilik akun (pelaku).", "Korban."], correctAnswer: 2 },
            { id: 13, category: 'bs', type: 'choice', question: "(B/S) Mode Pesawat menghapus jejak digital.", options: ["Benar", "Salah"], correctAnswer: 1 },
            { id: 14, category: 'bs', type: 'choice', question: "(B/S) VPN mengenkripsi koneksi internet.", options: ["Benar", "Salah"], correctAnswer: 0 },
            { id: 15, category: 'match', type: 'complex_match', question: "Pasangkan jenis Ancaman Siber:", pairs: [{ left: "Phishing", right: "Link Palsu" }, { left: "Doxing", right: "Sebar Data Pribadi" }, { left: "Sniffing", right: "Penyadapan Data" }, { left: "Defacing", right: "Peretasan Web" }] },
            { id: 16, category: 'match', type: 'complex_match', question: "Jodohkan aktivitas jejak digital:", pairs: [{ left: "Jejak Aktif", right: "Posting IG" }, { left: "Jejak Pasif", right: "Log Server" }, { left: "Metadata", right: "Lokasi Foto" }, { left: "Cookies", right: "Simpan Login" }] },
            { id: 17, category: 'match', type: 'complex_match', question: "Pasangkan fitur keamanan:", pairs: [{ left: "2FA", right: "Verifikasi 2 Langkah" }, { left: "Password Manager", right: "Sandi Rumit" }, { left: "Incognito", right: "Tanpa History" }, { left: "VPN", right: "Enkripsi Jalur" }] },
            { id: 18, category: 'match', type: 'complex_match', question: "Jodohkan istilah Etika:", pairs: [{ left: "Cyberbullying", right: "Perundungan" }, { left: "Plagiarisme", right: "Curi Karya" }, { left: "Hate Speech", right: "Ujaran Kebencian" }, { left: "Hoaks", right: "Berita Bohong" }] },
            { id: 19, category: 'match', type: 'complex_match', question: "Pasangkan Risiko File:", pairs: [{ left: ".exe", right: "Sangat Berisiko" }, { left: ".jpg", right: "Risiko Rendah" }, { left: ".pdf", right: "Risiko Sedang" }, { left: ".zip", right: "Perlu Scan" }] },
            { id: 28, category: 'essay', type: 'essay', question: "Mengapa universitas cek jejak digital pelamar?", keywords: ["karakter", "reputasi", "integritas"], minKeywords: 2 },
            { id: 29, category: 'essay', type: 'essay', question: "Jelaskan dilema Kenyamanan vs Privasi pada GPS Ojol!", keywords: ["mudah", "lacak", "privasi"], minKeywords: 2 },
            { id: 30, category: 'essay', type: 'essay', question: "3 Langkah jika ada akun palsu pakai namamu?", keywords: ["lapor", "blokir", "klarifikasi"], minKeywords: 2 },
            { id: 31, category: 'essay', type: 'essay', question: "Apakah jejak pasif lebih bahaya dari aktif? Jelaskan!", keywords: ["tanpa sadar", "profiling"], minKeywords: 2 },
            { id: 32, category: 'essay', type: 'essay', question: "Buat slogan 'Think Before You Post' dan maknanya!", keywords: ["pikir", "masa depan"], minKeywords: 2 }
        ];

        // --- UTILS ---
        const shuffleArray = (array) => [...array].sort(() => Math.random() - 0.5);
        const simulateAIAnalysis = async (ans, keys, min) => new Promise(r => setTimeout(() => {
            if(!ans || ans.length < 5) return r({score: 0, feedback: "Terlalu singkat"});
            const h = keys.filter(k => ans.toLowerCase().includes(k)).length;
            r({score: h >= min ? 100 : h > 0 ? 50 : 20, feedback: "Dinilai AI"});
        }, 800));

        // ==========================================
        // COMPONENTS (CBT STYLE)
        // ==========================================

        function LoginScreen({ onLogin }) {
            const [isAdmin, setIsAdmin] = useState(false);
            const [form, setForm] = useState({ name: '', pass: '', kelas: '', absen: '' });

            const handleSubmit = () => {
                if (isAdmin) {
                    if (form.pass === 'admin123') onLogin('Guru Admin', 'admin');
                    else alert('Password salah!');
                } else {
                    if (form.name && form.kelas && form.absen) onLogin(form.name.toUpperCase(), 'student', { kelas: form.kelas, absen: form.absen });
                    else alert('Lengkapi data siswa!');
                }
            };

            return (
                <div className="min-h-screen bg-slate-200 flex items-center justify-center p-4">
                    <div className="bg-white rounded-md shadow-lg w-full max-w-sm overflow-hidden border-t-4 border-cbtBlue">
                        <div className="bg-slate-50 p-6 text-center border-b border-slate-200">
                            <h1 className="text-xl font-bold text-slate-800 uppercase tracking-tight">CBT Informatika</h1>
                            <p className="text-xs text-slate-500 mt-1">Computer Based Test</p>
                        </div>

                        <div className="p-6 space-y-4">
                            <div className="flex bg-slate-100 p-1 rounded mb-2">
                                <button onClick={() => setIsAdmin(false)} className={`flex-1 py-1.5 text-xs font-bold rounded transition ${!isAdmin ? 'bg-white text-cbtBlue shadow-sm' : 'text-slate-500'}`}>SISWA</button>
                                <button onClick={() => setIsAdmin(true)} className={`flex-1 py-1.5 text-xs font-bold rounded transition ${isAdmin ? 'bg-white text-cbtBlue shadow-sm' : 'text-slate-500'}`}>GURU</button>
                            </div>

                            {!isAdmin ? (
                                <>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-600 mb-1">Nama Lengkap</label>
                                        <input type="text" value={form.name} onChange={e => setForm({...form, name: e.target.value.toUpperCase()})} className="w-full p-2 text-sm border border-slate-300 rounded focus:border-cbtBlue focus:ring-1 focus:ring-cbtBlue outline-none uppercase" placeholder="Masukkan Nama" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-600 mb-1">Kelas</label>
                                            <select value={form.kelas} onChange={e => setForm({...form, kelas: e.target.value})} className="w-full p-2 text-sm border border-slate-300 rounded focus:border-cbtBlue outline-none bg-white">
                                                <option value="">- Pilih -</option>
                                                {['VIII-A','VIII-B','VIII-C','VIII-D','VIII-E','VIII-F','VIII-G','VIII-H'].map(k => <option key={k} value={k}>{k}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-600 mb-1">Absen</label>
                                            <input type="number" value={form.absen} onChange={e => setForm({...form, absen: e.target.value})} className="w-full p-2 text-sm border border-slate-300 rounded focus:border-cbtBlue outline-none" placeholder="1-40" />
                                        </div>
                                    </div>
                                </>
                            ) : (
                                <div>
                                    <label className="block text-xs font-bold text-slate-600 mb-1">Password Admin</label>
                                    <input type="password" value={form.pass} onChange={e => setForm({...form, pass: e.target.value})} className="w-full p-2 text-sm border border-slate-300 rounded focus:border-cbtBlue outline-none" />
                                </div>
                            )}
                            <button onClick={handleSubmit} className="w-full py-2.5 bg-cbtBlue hover:bg-blue-700 text-white rounded font-bold text-sm shadow-sm mt-4">LOGIN</button>
                        </div>
                        <div className="bg-slate-50 p-3 text-center text-[10px] text-slate-400 border-t border-slate-200">
                            &copy; 2024 Ujian Berbasis Komputer
                        </div>
                    </div>
                </div>
            );
        }

        function StudentDashboard({ user, onStart }) {
            return (
                <div className="min-h-screen bg-slate-200 flex items-center justify-center p-4">
                    <div className="bg-white rounded-md shadow-lg w-full max-w-lg overflow-hidden border border-slate-200">
                        <div className="bg-cbtBlue p-4 text-white flex items-center justify-between">
                            <h2 className="font-bold text-lg">Konfirmasi Data</h2>
                            <Icon path={Icons.User} className="w-5 h-5 opacity-80" />
                        </div>
                        <div className="p-6">
                            <table className="w-full text-sm mb-6">
                                <tbody>
                                    <tr className="border-b border-slate-100"><td className="py-2 text-slate-500 w-32">Nama Peserta</td><td className="py-2 font-bold">{user.name}</td></tr>
                                    <tr className="border-b border-slate-100"><td className="py-2 text-slate-500">Kelas / Absen</td><td className="py-2 font-bold">{user.kelas} / {user.absen}</td></tr>
                                    <tr className="border-b border-slate-100"><td className="py-2 text-slate-500">Mata Pelajaran</td><td className="py-2 font-bold">Informatika (Jejak Digital)</td></tr>
                                    <tr className="border-b border-slate-100"><td className="py-2 text-slate-500">Jumlah Soal</td><td className="py-2 font-bold">25 Butir</td></tr>
                                    <tr><td className="py-2 text-slate-500">Waktu</td><td className="py-2 font-bold">40 Menit</td></tr>
                                </tbody>
                            </table>
                            
                            <div className="bg-yellow-50 border border-yellow-200 p-3 rounded text-xs text-yellow-800 mb-6">
                                <strong>Petunjuk:</strong> Klik tombol <strong>MULAI</strong> jika data sudah benar. Waktu akan berjalan otomatis.
                            </div>

                            <button onClick={onStart} className="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded font-bold text-sm shadow-sm">MULAI UJIAN</button>
                        </div>
                    </div>
                </div>
            );
        }

        function ExamInterface({ questions, answers, setAnswers, onSubmit, timeLeft, currentIndex, setCurrentIndex, isSubmitting }) {
            const [drawerOpen, setDrawerOpen] = useState(false);
            const [selectedAnswer, setSelectedAnswer] = useState(null); 
            
            // --- SAFETY CHECK (Mencegah Crash jika questions kosong) ---
            if (!questions || questions.length === 0 || !questions[currentIndex]) {
                return (
                    <div className="min-h-screen bg-slate-100 flex flex-col items-center justify-center p-4">
                        <div className="w-12 h-12 border-4 border-cbtBlue border-t-transparent rounded-full animate-spin mb-4"></div>
                        <p className="text-slate-600 font-bold">Memuat Soal...</p>
                        <button onClick={() => { localStorage.removeItem('cbt_sess_v4'); window.location.reload(); }} className="mt-4 text-xs text-blue-500 hover:underline">Reset & Refresh</button>
                    </div>
                );
            }

            const q = questions[currentIndex];
            const isLast = currentIndex === questions.length - 1;
            const isFirstQuestion = currentIndex === 0;

            const formatTime = s => {
                const m = Math.floor(s/60);
                const secs = s%60;
                return `${m < 10 ? '0'+m : m}:${secs < 10 ? '0'+secs : secs}`;
            };

            const handleNext = () => !isLast && setCurrentIndex(currentIndex + 1);
            const handlePrev = () => !isFirstQuestion && setCurrentIndex(currentIndex - 1);

            // Menjodohkan Logic (Compact Click)
            const handleMatchClick = (text) => setSelectedAnswer(selectedAnswer === text ? null : text);
            const handleSlotClick = (idx) => {
                if (!selectedAnswer) return;
                const prev = answers[q.id] || {};
                setAnswers({ ...answers, [q.id]: { ...prev, [idx]: selectedAnswer } });
                setSelectedAnswer(null);
            };
            const removeMatch = (idx) => {
                const prev = { ...answers[q.id] }; delete prev[idx];
                setAnswers({ ...answers, [q.id]: prev });
            };

            if (isSubmitting) return (
                <div className="fixed inset-0 bg-slate-900/80 z-50 flex flex-col items-center justify-center text-white">
                    <div className="w-10 h-10 border-4 border-white border-t-transparent rounded-full animate-spin mb-3"></div>
                    <span className="font-bold text-sm">Menyimpan Jawaban...</span>
                </div>
            );

            return (
                <div className="h-screen flex flex-col bg-slate-100 font-sans text-sm">
                    {/* HEADER (Compact) */}
                    <header className="bg-cbtBlue text-white h-12 flex items-center justify-between px-3 shadow-md shrink-0 z-20">
                        <div className="flex items-center gap-2">
                            <span className="font-bold text-lg">CBT</span>
                            <span className="bg-blue-500 px-2 py-0.5 rounded text-xs">Informatika</span>
                        </div>
                        <div className="flex items-center gap-2 bg-blue-700/50 px-2 py-1 rounded">
                            <Icon path={Icons.Clock} className="w-4 h-4" />
                            <span className={`font-mono font-bold ${timeLeft < 300 ? 'text-yellow-300 animate-pulse' : ''}`}>{formatTime(timeLeft)}</span>
                        </div>
                    </header>

                    {/* MAIN LAYOUT */}
                    <div className="flex-1 flex overflow-hidden relative">
                        
                        {/* SIDEBAR (Responsive Drawer) */}
                        <div className={`absolute inset-y-0 left-0 w-64 bg-white shadow-xl transform transition-transform z-30 lg:relative lg:transform-none lg:w-72 lg:shadow-none lg:border-r border-slate-300 flex flex-col ${drawerOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
                            <div className="p-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center lg:hidden">
                                <span className="font-bold text-slate-700">Daftar Soal</span>
                                <button onClick={()=>setDrawerOpen(false)} className="text-slate-500"><Icon path={Icons.X} className="w-5 h-5"/></button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-3">
                                <div className="grid grid-cols-5 gap-2">
                                    {questions.map((qn, idx) => {
                                        let filled = qn.type === 'complex_match' ? (answers[qn.id] && Object.keys(answers[qn.id]).length === 4) : (answers[qn.id] !== undefined && answers[qn.id] !== "");
                                        return (
                                            <button key={qn.id} onClick={()=>{setCurrentIndex(idx); setDrawerOpen(false);}}
                                                className={`h-8 w-full rounded border text-xs font-bold flex items-center justify-center transition
                                                    ${idx === currentIndex ? 'bg-cbtBlue text-white border-cbtBlue' : 
                                                      filled ? 'bg-green-100 text-green-700 border-green-300' : 'bg-white text-slate-600 border-slate-300 hover:bg-slate-50'}
                                                `}>{idx+1}</button>
                                        )
                                    })}
                                </div>
                            </div>
                            <div className="p-3 border-t border-slate-200 bg-slate-50 text-[10px] text-center text-slate-500">
                                Hijau: Dijawab | Biru: Aktif
                            </div>
                        </div>
                        {drawerOpen && <div className="fixed inset-0 bg-black/50 z-20 lg:hidden" onClick={()=>setDrawerOpen(false)}></div>}

                        {/* QUESTION AREA */}
                        <main className="flex-1 overflow-y-auto bg-slate-200 p-2 md:p-4">
                            <div className="bg-white rounded shadow-sm border border-slate-300 min-h-full flex flex-col">
                                {/* Question Header */}
                                <div className="p-3 border-b border-slate-200 bg-slate-50 flex justify-between items-center sticky top-0 z-10">
                                    <div className="flex items-center gap-2">
                                        <button onClick={()=>setDrawerOpen(true)} className="lg:hidden p-1.5 bg-white border border-slate-300 rounded text-slate-600"><Icon path={Icons.Menu} className="w-5 h-5"/></button>
                                        <span className="font-bold text-slate-700">Soal No. {currentIndex + 1}</span>
                                    </div>
                                    <span className="text-[10px] font-bold px-2 py-0.5 bg-slate-200 text-slate-600 rounded uppercase border border-slate-300">{q.type === 'complex_match' ? 'MENJODOHKAN' : q.type === 'essay' ? 'URAIAN' : 'PG'}</span>
                                </div>

                                {/* Question Body */}
                                <div className="p-4 md:p-6 flex-1 text-base">
                                    <p className="mb-5 leading-relaxed font-medium text-slate-800 question-text">{q.question}</p>

                                    {/* --- TIPE: PILIHAN GANDA --- */}
                                    {q.type === 'choice' && (
                                        <div className="space-y-2">
                                            {q.options.map((opt, idx) => (
                                                <div key={idx} onClick={() => setAnswers({...answers, [q.id]: idx})} 
                                                    className={`flex items-start gap-3 p-3 rounded border cursor-pointer hover:bg-slate-50 transition ${answers[q.id] === idx ? 'bg-blue-50 border-cbtBlue ring-1 ring-cbtBlue' : 'border-slate-300 bg-white'}`}>
                                                    <div className={`w-5 h-5 rounded-full border flex items-center justify-center shrink-0 mt-0.5 ${answers[q.id] === idx ? 'border-cbtBlue bg-cbtBlue' : 'border-slate-400'}`}>
                                                        {answers[q.id] === idx && <div className="w-2 h-2 bg-white rounded-full"></div>}
                                                    </div>
                                                    <span className={`option-text ${answers[q.id] === idx ? 'font-semibold text-cbtBlue' : 'text-slate-700'}`}>{opt}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {/* --- TIPE: MENJODOHKAN (COMPACT CLICK) --- */}
                                    {q.type === 'complex_match' && (
                                        <div className="space-y-4">
                                            {/* Target Area */}
                                            <div className="grid gap-2">
                                                {q.pairs.map((pair, idx) => {
                                                    const filled = answers[q.id]?.[idx];
                                                    return (
                                                        <div key={idx} className="flex flex-col sm:flex-row border border-slate-300 rounded bg-white overflow-hidden">
                                                            <div className="sm:w-1/2 p-2 bg-slate-50 border-b sm:border-b-0 sm:border-r border-slate-300 flex items-center gap-2 text-sm font-medium">
                                                                <span className="bg-slate-200 text-slate-600 text-xs w-5 h-5 flex items-center justify-center rounded font-bold">{String.fromCharCode(65+idx)}</span>
                                                                {pair.left}
                                                            </div>
                                                            <div onClick={() => handleSlotClick(idx)} 
                                                                className={`sm:w-1/2 p-2 min-h-[40px] flex items-center justify-center cursor-pointer transition relative 
                                                                    ${filled ? 'bg-blue-50' : 'bg-white hover:bg-slate-50'}
                                                                    ${selectedAnswer && !filled ? 'bg-yellow-50 border-2 border-yellow-400 border-dashed m-1 rounded' : ''}
                                                                `}>
                                                                {filled ? (
                                                                    <div className="flex justify-between w-full items-center px-2">
                                                                        <span className="text-sm font-bold text-blue-700">{filled}</span>
                                                                        <button onClick={(e)=>{e.stopPropagation(); removeMatch(idx)}} className="text-red-400 hover:text-red-600 ml-2"><Icon path={Icons.X} className="w-4 h-4"/></button>
                                                                    </div>
                                                                ) : <span className={`text-xs uppercase font-bold ${selectedAnswer ? 'text-yellow-600 animate-pulse' : 'text-slate-300'}`}>{selectedAnswer ? "PILIH SINI" : "KOSONG"}</span>}
                                                            </div>
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                            
                                            {/* Source Options */}
                                            <div className="bg-slate-100 p-3 rounded border border-slate-300">
                                                <p className="text-xs font-bold text-slate-500 mb-2 uppercase text-center">Pilihan Jawaban (Klik untuk Memilih)</p>
                                                <div className="flex flex-wrap gap-2 justify-center">
                                                    {q.shuffledAnswers.map((ans, i) => {
                                                        const isUsed = Object.values(answers[q.id] || {}).includes(ans);
                                                        return (
                                                            <button key={i} disabled={isUsed} onClick={() => setSelectedAnswer(selectedAnswer === ans ? null : ans)}
                                                                className={`px-3 py-1.5 rounded border text-sm font-semibold shadow-sm transition
                                                                    ${isUsed ? 'bg-slate-200 text-slate-400 border-slate-200 cursor-not-allowed' : 
                                                                      selectedAnswer === ans ? 'bg-cbtBlue text-white border-blue-800 ring-2 ring-blue-300' : 'bg-white text-slate-700 border-slate-300 hover:border-blue-500'}
                                                                `}>
                                                                {ans}
                                                            </button>
                                                        )
                                                    })}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* --- TIPE: URAIAN --- */}
                                    {q.type === 'essay' && (
                                        <textarea 
                                            value={answers[q.id] || ''}
                                            onChange={e => setAnswers({...answers, [q.id]: e.target.value})}
                                            className="w-full h-48 p-3 text-sm border border-slate-300 rounded focus:border-cbtBlue focus:ring-1 focus:ring-cbtBlue outline-none resize-none leading-relaxed"
                                            placeholder="Ketik jawaban Anda di sini..."
                                        ></textarea>
                                    )}
                                </div>

                                {/* FOOTER BUTTONS */}
                                <div className="p-3 border-t border-slate-200 bg-slate-50 flex justify-between items-center sticky bottom-0 z-10">
                                    {isFirstQuestion ? <div></div> : (
                                        <button onClick={handlePrev} className="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded font-bold text-sm shadow-sm hover:bg-slate-50 flex items-center gap-1">
                                            <Icon path={Icons.Left} className="w-4 h-4"/> Prev
                                        </button>
                                    )}

                                    {isLast ? (
                                        <button onClick={() => confirm("Yakin ingin selesai?") && onSubmit()} className="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-bold text-sm shadow-sm flex items-center gap-1">
                                            SELESAI <Icon path={Icons.Check} className="w-4 h-4"/>
                                        </button>
                                    ) : (
                                        <button onClick={handleNext} className="px-6 py-2 bg-cbtBlue hover:bg-blue-700 text-white rounded font-bold text-sm shadow-sm flex items-center gap-1">
                                            Next <Icon path={Icons.Right} className="w-4 h-4"/>
                                        </button>
                                    )}
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
            );
        }

        function ResultScreen({ score, user, onHome }) {
            const isLulus = score >= 75;
            return (
                <div className="min-h-screen bg-slate-200 flex items-center justify-center p-4">
                    <div className="bg-white rounded shadow-lg p-8 max-w-sm w-full text-center border-t-4 border-cbtBlue">
                        <h2 className="text-xl font-bold text-slate-800 mb-2">UJIAN SELESAI</h2>
                        <p className="text-sm text-slate-500 mb-6">Jawaban Anda telah tersimpan.</p>
                        
                        <div className="bg-slate-50 border border-slate-200 rounded p-4 mb-6">
                            <span className="block text-xs font-bold text-slate-400 uppercase">Skor Anda</span>
                            <span className={`block text-5xl font-black mt-2 ${isLulus ? 'text-green-600' : 'text-red-600'}`}>{score}</span>
                            <span className="block text-xs font-bold mt-2 px-2 py-1 rounded inline-block bg-slate-200 text-slate-600">KKM: 75</span>
                        </div>
                        
                        <button onClick={onHome} className="w-full py-2 bg-slate-800 text-white rounded font-bold text-sm hover:bg-slate-900">KELUAR</button>
                    </div>
                </div>
            );
        }

        // --- ADMIN PANEL (Compact) ---
        function AdminPanel({ onLogout }) {
            const [data, setData] = useState([]);
            useEffect(() => {
                if(supabaseClient) supabaseClient.from('exam_results').select('*').order('created_at', { ascending: false }).then(({ data }) => setData(data || []));
                else setData(JSON.parse(localStorage.getItem('cbt_local_results') || '[]'));
            }, []);

            const download = () => {
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Nilai");
                XLSX.writeFile(wb, "Rekap_Nilai.xlsx");
            };

            return (
                <div className="min-h-screen bg-slate-100 p-4">
                    <div className="max-w-5xl mx-auto bg-white rounded shadow-sm border border-slate-200">
                        <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                            <h2 className="font-bold text-slate-700">PANEL GURU</h2>
                            <div className="flex gap-2">
                                <button onClick={download} className="px-3 py-1.5 bg-green-600 text-white rounded text-xs font-bold hover:bg-green-700">EXCEL</button>
                                <button onClick={onLogout} className="px-3 py-1.5 bg-slate-700 text-white rounded text-xs font-bold hover:bg-slate-800">LOGOUT</button>
                            </div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-100 text-slate-600 border-b border-slate-200 font-bold">
                                    <tr><th className="p-3">Waktu</th><th className="p-3">Nama</th><th className="p-3">Kelas</th><th className="p-3">Nilai</th></tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {data.map((r,i)=>(
                                        <tr key={i} className="hover:bg-blue-50/50">
                                            <td className="p-3 text-slate-500">{new Date(r.created_at||r.date).toLocaleString()}</td>
                                            <td className="p-3 font-bold text-slate-800">{r.name}</td>
                                            <td className="p-3">{r.kelas}</td>
                                            <td className="p-3 font-bold text-cbtBlue">{r.score}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [state, setState] = useState({ view: 'login', user: null, questions: [], answers: {}, score: 0, timeLeft: 40*60, currentIndex: 0 });
            const [submitting, setSubmitting] = useState(false);
            const [loading, setLoading] = useState(true);

            // Restore Session & Validate (FIXED: WITH LOADING STATE)
            useEffect(() => {
                const s = localStorage.getItem('cbt_sess_v4');
                if(s) { 
                    try { 
                        const parsed = JSON.parse(s);
                        // SAFETY: Check if questions exist
                        if(parsed.view === 'exam' && (!parsed.questions || parsed.questions.length === 0)) {
                            localStorage.removeItem('cbt_sess_v4');
                        } else {
                            setState(parsed); 
                        }
                    } catch(e) { localStorage.removeItem('cbt_sess_v4'); } 
                }
                setLoading(false);
            }, []);

            useEffect(() => {
                if(state.user) localStorage.setItem('cbt_sess_v4', JSON.stringify(state));
            }, [state]);

            useEffect(() => {
                if(state.view === 'exam' && state.timeLeft > 0) {
                    const t = setInterval(() => setState(p => ({...p, timeLeft: p.timeLeft - 1})), 1000);
                    return () => clearInterval(t);
                } else if(state.timeLeft === 0 && state.view === 'exam') submit();
            }, [state.view, state.timeLeft]);

            const startExam = () => {
                const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);
                const qMc = shuffle(INITIAL_QUESTIONS.filter(q => q.category === 'mc')).slice(0, 8);
                const qBs = shuffle(INITIAL_QUESTIONS.filter(q => q.category === 'bs')).slice(0, 2);
                const qMatch = shuffle(INITIAL_QUESTIONS.filter(q => q.category === 'match')).slice(0, 5).map(q => ({
                    ...q, shuffledAnswers: shuffle(q.pairs.map(p => p.right))
                }));
                const qEssay = shuffle(INITIAL_QUESTIONS.filter(q => q.category === 'essay')).slice(0, 7);
                setState(p => ({...p, view: 'exam', questions: [...qMc, ...qBs, ...qMatch, ...qEssay], answers: {}, timeLeft: 40*60, currentIndex: 0}));
            };

            const submit = async () => {
                setSubmitting(true);
                let score = 0;
                // Scoring Logic (Simplified)
                const qChoice = state.questions.filter(q => q.type === 'choice');
                const scorePerQ = 60 / (qChoice.length || 1);
                qChoice.forEach(q => { if(state.answers[q.id] === q.correctAnswer) score += scorePerQ; });
                
                const qMatch = state.questions.filter(q => q.type === 'complex_match');
                const scorePerPair = 40 / ((qMatch.length * 4) || 1);
                qMatch.forEach(q => {
                    const ans = state.answers[q.id] || {};
                    q.pairs.forEach((p, idx) => { if(ans[idx] === p.right) score += scorePerPair; });
                });
                
                const finalScore = Math.round(score);
                
                if(supabaseClient) await supabaseClient.from('exam_results').insert([{ name: state.user.name, kelas: state.user.kelas, absen: state.user.absen, score: finalScore, detail: { raw: state.answers } }]);
                else {
                    const local = JSON.parse(localStorage.getItem('cbt_local_results')||'[]');
                    local.push({ name: state.user.name, kelas: state.user.kelas, score: finalScore, date: new Date() });
                    localStorage.setItem('cbt_local_results', JSON.stringify(local));
                }

                localStorage.removeItem('cbt_sess_v4');
                setState(p => ({...p, view: 'result', score: finalScore}));
                setSubmitting(false);
            };

            const logout = () => { localStorage.removeItem('cbt_sess_v4'); setState({view:'login', user:null}); };

            // --- LOADING SCREEN (Mencegah Flash Login saat Refresh) ---
            if(loading) return (
                <div className="flex h-screen items-center justify-center bg-slate-50 flex-col">
                    <div className="w-10 h-10 border-4 border-cbtBlue border-t-transparent rounded-full animate-spin mb-3"></div>
                    <span className="text-slate-500 font-bold text-sm">MEMUAT SESI...</span>
                </div>
            );

            if(state.view === 'login') return <LoginScreen onLogin={(n,r,d) => setState(p => ({...p, user:{name:n, role:r, ...d}, view: r==='admin'?'admin':'dashboard'}))} />;
            if(state.view === 'dashboard') return <StudentDashboard user={state.user} onStart={startExam} />;
            if(state.view === 'exam') return <ExamInterface 
                questions={state.questions} 
                answers={state.answers} 
                setAnswers={a => setState(p => ({...p, answers: a}))} 
                timeLeft={state.timeLeft} 
                currentIndex={state.currentIndex} 
                setCurrentIndex={i => setState(p => ({...p, currentIndex: i}))} 
                onSubmit={submit} 
                isSubmitting={submitting} 
            />;
            if(state.view === 'result') return <ResultScreen score={state.score} user={state.user} onHome={logout} />;
            if(state.view === 'admin') return <AdminPanel onLogout={logout} />;
            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
